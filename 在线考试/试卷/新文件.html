<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ ä½³æ›¦çƒ¤åœ°ç“œğŸ è€ƒè¯•ç³»ç»ŸğŸ“</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --error: #e74c3c;
            --background: #f8f9fa;
            --text-color: #333;
            --card-background: white;
            --border-color: #eee;
        }

        /* æŠ¤çœ¼æ¨¡å¼ä¸ºé»˜è®¤ */
        body.eye-protection-mode {
            --background: #f5f5dc;
            --text-color: #333;
            --card-background: #fffff0;
            --border-color: #ccc;
        }

        body.dark-mode {
            --background: #121212;
            --text-color: #d0d0d0;
            --card-background: #1e1e1e;
            --border-color: #333;
            --primary: #1f1f1f;
            --secondary: #4db8ff;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            margin: 20px;
            background: var(--background);
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            color: var(--text-color);
        }

        .question-card {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin: 15px 0;
            background: var(--card-background);
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }

        button {
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        #importMenu, #visualEditor {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .import-option, .editor-section {
            margin-bottom: 10px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            color: var(--text-color);
            margin-bottom: 10px;
        }

        textarea {
            height: 200px;
        }

        .json-example {
            font-family: monospace;
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-item input[type="text"] {
            flex: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }

        .option-item button {
            padding: 6px 12px;
        }

        .correct-answer {
            margin-top: 10px;
        }

        .preview-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed var(--border-color);
            border-radius: 6px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 8px 16px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-bottom: none;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            margin-right: 5px;
        }

        .tab-button.active {
            background: var(--secondary);
            color: white;
        }
    </style>
</head>

<body class="eye-protection-mode">
    <div class="container">
        <div class="toolbar">
            <!-- ä¸»é¢˜é€‰æ‹©ä¸‹æ‹‰èœå• -->
            <select id="themeSelect" onchange="setMode(this.value)">
                <option value="eye-protection">æŠ¤çœ¼æ¨¡å¼</option>
                <option value="dark">å¤œé—´æ¨¡å¼</option>
                <option value="default">é»˜è®¤æ¨¡å¼</option>
            </select>

            <!-- åŠŸèƒ½æŒ‰é’® -->
            <button onclick="switchExam()">åˆ‡æ¢è¯•å·</button>
            <button onclick="toggleImportMenu()">å¯¼å…¥è¯•å·</button>
            <button onclick="showVisualEditor()">å¯è§†åŒ–å‡ºé¢˜</button>
            <button id="examControlBtn" onclick="startOrSubmitExam()">å¼€å§‹è€ƒè¯•</button>
        </div>

        <h1>ä½³æ›¦ğŸ§¨çƒ¤åœ°ç“œğŸ åœ¨çº¿è€ƒè¯•ç³»ç»ŸğŸ“</h1>
        <label for="studentName">è€ƒç”Ÿå§“å:</label>
        <input type="text" id="studentName" placeholder="è¯·è¾“å…¥è€ƒç”Ÿå§“å" required>
        <div class="timer" id="timer">å‰©ä½™æ—¶é—´: 30:00</div>
        
        <!-- å¯¼å…¥è¯•å·èœå• -->
        <div id="importMenu">
            <div class="tab-buttons">
                <div class="tab-button active" onclick="switchTab('fileTab')">ä¸Šä¼ JSONæ–‡ä»¶</div>
                <div class="tab-button" onclick="switchTab('pasteTab')">é—®AIè¦æ•°æ®</div>
            </div>
            
            <div id="fileTab" class="import-option">
                <h3>æ–¹å¼ä¸€ï¼šä¸Šä¼ JSONæ–‡ä»¶</h3>
                <input type="file" id="importFile" accept=".json">
                <button onclick="importFromFile()">ç¡®è®¤ä¸Šä¼ </button>
            </div>
            
            <div id="pasteTab" class="import-option" style="display:none;">
                <h3>æ–¹å¼äºŒï¼šé—®åˆ«çš„AIè¦æ•°æ®</h3>
                <textarea id="jsonInput" placeholder="è¯·åœ¨æ­¤ç²˜è´´JSONæ ¼å¼çš„è¯•å·æ•°æ®..."></textarea>
                <button onclick="importFromText()">ç¡®è®¤å¯¼å…¥</button>
                
                <details>
                    <summary>å¤åˆ¶ä»¥ä¸‹JSONæ ¼å¼ç¤ºä¾‹</summary>
                    <div class="json-example">
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ•°æ®æ ¼å¼ï¼Œå¸®æˆ‘å‡ºå°å­¦ä¸‰å¹´çº§è€ƒè¯•é¢˜ç›®:
[
    {
        "type": "radio",
        "content": "ä¸­å›½çš„é¦–éƒ½æ˜¯å“ªä¸ªåŸå¸‚ï¼Ÿ",
        "options": ["åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·"],
        "correct": "A"
    },
    {
        "type": "text",
        "content": "ã€Šé™å¤œæ€ã€‹çš„ä½œè€…æ˜¯è°ï¼Ÿ",
        "correct": "æç™½"
    },
    {
        "type": "checkbox",
        "content": "ä»¥ä¸‹å“ªäº›æ˜¯æ°´æœï¼Ÿ",
        "options": ["è‹¹æœ", "åœŸè±†", "é¦™è•‰", "è¥¿çº¢æŸ¿"],
        "correct": ["A", "C"]
    }
]
                    </div>
                </details>
            </div>
        </div>

        <!-- å¯è§†åŒ–ç¼–è¾‘å™¨ -->
        <div id="visualEditor">
            <h2>å¯è§†åŒ–é¢˜ç›®ç¼–è¾‘å™¨</h2>
            <div class="editor-section">
                <label for="questionType">é¢˜ç›®ç±»å‹:</label>
                <select id="questionType" onchange="changeQuestionType()">
                    <option value="radio">å•é€‰é¢˜</option>
                    <option value="checkbox">å¤šé€‰é¢˜</option>
                    <option value="text">å¡«ç©ºé¢˜</option>
                </select>
            </div>
            
            <div class="editor-section">
                <label for="questionContent">é¢˜ç›®å†…å®¹:</label>
                <textarea id="questionContent" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹..."></textarea>
            </div>
            
            <div id="optionsSection" class="editor-section">
                <label>é¢˜ç›®é€‰é¡¹:</label>
                <div id="optionsContainer">
                    <div class="option-item">
                        <input type="text" placeholder="é€‰é¡¹A">
                        <button onclick="removeOption(this)">åˆ é™¤</button>
                    </div>
                    <div class="option-item">
                        <input type="text" placeholder="é€‰é¡¹B">
                        <button onclick="removeOption(this)">åˆ é™¤</button>
                    </div>
                </div>
                <button onclick="addOption()">æ·»åŠ é€‰é¡¹</button>
            </div>
            
            <div id="correctAnswerSection" class="editor-section correct-answer">
                <label>æ­£ç¡®ç­”æ¡ˆ:</label>
                <div id="radioAnswer" style="display:block;">
                    <select id="radioCorrect">
                        <option value="A">A</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div id="checkboxAnswer" style="display:none;">
                    <label><input type="checkbox" name="checkboxCorrect" value="A"> A</label>
                    <label><input type="checkbox" name="checkboxCorrect" value="B"> B</label>
                </div>
                <div id="textAnswer" style="display:none;">
                    <input type="text" id="textCorrect" placeholder="è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ">
                </div>
            </div>
            
            <div class="editor-section">
                <button onclick="addQuestion()">æ·»åŠ åˆ°è¯•å·</button>
                <button onclick="generateJson()">ç”ŸæˆJSON</button>
                <button onclick="clearEditor()">æ¸…ç©ºç¼–è¾‘å™¨</button>
            </div>
            
            <div class="preview-area">
                <h3>å½“å‰è¯•å·é¢„è§ˆ (å…±<span id="questionCount">0</span>é¢˜)</h3>
                <div id="questionPreview"></div>
                <button onclick="saveQuestions()" style="margin-top:10px;">ä¿å­˜ä¸ºå½“å‰è¯•å·</button>
            </div>
        </div>

        <div id="questionContainer"></div>
    </div>

    <script>
        // ================= å…¨å±€å˜é‡ =================
        let currentQuestions = [];
        let currentExam = 'questions.json';
        let timeLeft = 1800; // 30åˆ†é’Ÿ
        let timerInterval;
        let importMenuVisible = false;
        let editorQuestions = [];
        let examStarted = false;

        // ================= ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ =================
        function setMode(mode) {
            document.body.className = mode + '-mode';
            localStorage.setItem('mode', mode);
        }

        // ================= åˆå§‹åŒ– =================
        window.onload = function() {
            // è®¾ç½®ä¸»é¢˜
            const savedMode = localStorage.getItem('mode') || 'eye-protection';
            document.getElementById('themeSelect').value = savedMode;
            setMode(savedMode);
            
            // åˆå§‹åŒ–è€ƒè¯•
            initExam();
            
            // éšè—å¯¼å…¥èœå•å’Œç¼–è¾‘å™¨
            document.getElementById('importMenu').style.display = 'none';
            document.getElementById('visualEditor').style.display = 'none';
            
            // ç¦ç”¨é¢˜ç›®å®¹å™¨ï¼Œç›´åˆ°è€ƒè¯•å¼€å§‹
            document.getElementById('questionContainer').style.pointerEvents = 'none';
            document.getElementById('questionContainer').style.opacity = '0.6';
        };

        // ================= è€ƒè¯•åŠŸèƒ½ =================
        async function initExam() {
            clearInterval(timerInterval);
            timeLeft = 1800;
            updateTimerDisplay();
            examStarted = false;
            updateExamControlButton();

            try {
                const response = await fetch(`./data/${currentExam}`);
                if (!response.ok) throw new Error(`æ— æ³•åŠ è½½è¯•å·ï¼š${currentExam}`);
                currentQuestions = await response.json();
                renderQuestions();
            } catch (error) {
                console.error(error);
                alert('åŠ è½½è¯•å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼');
            }
        }

        function switchExam() {
            if (examStarted) {
                if (!confirm('è€ƒè¯•å·²ç»å¼€å§‹ï¼Œåˆ‡æ¢è¯•å·å°†é‡ç½®å½“å‰è€ƒè¯•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    return;
                }
            }
            currentExam = currentExam === 'questions.json' ? 'questions1.json' : 'questions.json';
            initExam();
        }

        function renderQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = currentQuestions.map((q, index) => `
                <div class="question-card">
                    <h3>é¢˜ç›® ${index + 1} (${getQuestionTypeName(q.type)})</h3>
                    <p>${q.content}</p>
                    ${q.options ? q.options.map((opt, optIndex) => `
                        <label style="display:block; margin:8px 0;">
                            <input type="${q.type}" name="q${index}" value="${opt}">
                            ${String.fromCharCode(65 + optIndex)}. ${opt}
                        </label>
                    `).join('') : ''}
                    ${q.type === 'text' ? `
                        <input type="text" style="width:100%; padding:8px;" 
                               placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" data-question-id="${index}">
                    ` : ''}
                </div>
            `).join('');
        }

        function getQuestionTypeName(type) {
            return {
                'text': 'å¡«ç©º',
                'radio': 'å•é€‰',
                'checkbox': 'å¤šé€‰'
            }[type] || 'æœªçŸ¥';
        }

        // ================= è€ƒè¯•æ§åˆ¶æŒ‰é’®åŠŸèƒ½ =================
        function startOrSubmitExam() {
            if (examStarted) {
                submitExam();
            } else {
                startExam();
            }
        }

        function startExam() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('è¯·è¾“å…¥è€ƒç”Ÿå§“åï¼');
                return;
            }
            
            examStarted = true;
            updateExamControlButton();
            
            // å¯ç”¨é¢˜ç›®å®¹å™¨
            document.getElementById('questionContainer').style.pointerEvents = 'auto';
            document.getElementById('questionContainer').style.opacity = '1';
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
        }

        function updateExamControlButton() {
            const btn = document.getElementById('examControlBtn');
            if (examStarted) {
                btn.textContent = 'æäº¤è¯•å·';
                btn.style.backgroundColor = 'var(--success)';
            } else {
                btn.textContent = 'å¼€å§‹è€ƒè¯•';
                btn.style.backgroundColor = 'var(--secondary)';
            }
        }

        // ================= è®¡æ—¶å™¨åŠŸèƒ½ =================
        function startTimer() {
            clearInterval(timerInterval); // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            timeLeft = 1800;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `å‰©ä½™æ—¶é—´: ${minutes}:${seconds}`;
            
            // æ—¶é—´ä¸è¶³5åˆ†é’Ÿæ—¶å˜çº¢è‰²
            if (timeLeft <= 300) {
                document.getElementById('timer').style.backgroundColor = 'var(--error)';
            }
        }

        // ================= å¯¼å…¥åŠŸèƒ½ =================
        function toggleImportMenu() {
            const menu = document.getElementById('importMenu');
            const editor = document.getElementById('visualEditor');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            editor.style.display = 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.import-option').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function importFromFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndImport(data);
                } catch (e) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + e.message);
                }
            };
            
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            reader.readAsText(file);
        }

        function importFromText() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            if (!jsonText) {
                alert('è¯·è¾“å…¥JSONæ•°æ®');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                validateAndImport(data);
            } catch (e) {
                alert('JSONè§£æå¤±è´¥ï¼š' + e.message);
            }
        }

        function validateAndImport(data) {
            if (!Array.isArray(data)) {
                throw new Error('è¯•å·æ•°æ®å¿…é¡»æ˜¯æ•°ç»„');
            }
            
            // ç®€å•éªŒè¯é¢˜ç›®æ ¼å¼
            const isValid = data.every(q => {
                return q.content && q.correct && 
                      (q.type === 'text' || (q.options && Array.isArray(q.options)));
            });
            
            if (!isValid) {
                throw new Error('è¯•å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥é¢˜ç›®ç»“æ„');
            }
            
            currentQuestions = data;
            renderQuestions();
            alert(`æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®`);
            document.getElementById('importMenu').style.display = 'none';
        }

        // ================= å¯è§†åŒ–ç¼–è¾‘å™¨åŠŸèƒ½ =================
        function showVisualEditor() {
            const menu = document.getElementById('importMenu');
            const editor = document.getElementById('visualEditor');
            menu.style.display = 'none';
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
            
            // åˆå§‹åŒ–ç¼–è¾‘å™¨çŠ¶æ€
            if (editor.style.display === 'block') {
                updatePreview();
            }
        }

        function changeQuestionType() {
            const type = document.getElementById('questionType').value;
            
            // æ˜¾ç¤º/éšè—é€‰é¡¹éƒ¨åˆ†
            document.getElementById('optionsSection').style.display = 
                type === 'text' ? 'none' : 'block';
            
            // åˆ‡æ¢æ­£ç¡®ç­”æ¡ˆè¾“å…¥æ–¹å¼
            document.getElementById('radioAnswer').style.display = 
                type === 'radio' ? 'block' : 'none';
            document.getElementById('checkboxAnswer').style.display = 
                type === 'checkbox' ? 'block' : 'none';
            document.getElementById('textAnswer').style.display = 
                type === 'text' ? 'block' : 'none';
        }

        function addOption() {
            const container = document.getElementById('optionsContainer');
            const optionCount = container.children.length;
            const nextChar = String.fromCharCode(65 + optionCount);
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" placeholder="é€‰é¡¹${nextChar}">
                <button onclick="removeOption(this)">åˆ é™¤</button>
            `;
            container.appendChild(optionDiv);
            
            // æ›´æ–°å•é€‰/å¤šé€‰ç­”æ¡ˆé€‰é¡¹
            updateAnswerOptions();
        }

        function removeOption(button) {
            const container = document.getElementById('optionsContainer');
            if (container.children.length <= 2) {
                alert('è‡³å°‘éœ€è¦ä¸¤ä¸ªé€‰é¡¹');
                return;
            }
            
            button.parentElement.remove();
            updateAnswerOptions();
        }

        function updateAnswerOptions() {
            const container = document.getElementById('optionsContainer');
            const options = container.children;
            
            // æ›´æ–°å•é€‰ä¸‹æ‹‰æ¡†
            const radioSelect = document.getElementById('radioCorrect');
            radioSelect.innerHTML = '';
            for (let i = 0; i < options.length; i++) {
                const char = String.fromCharCode(65 + i);
                radioSelect.innerHTML += `<option value="${char}">${char}</option>`;
            }
            
            // æ›´æ–°å¤šé€‰å¤é€‰æ¡†
            const checkboxContainer = document.getElementById('checkboxAnswer');
            checkboxContainer.innerHTML = '';
            for (let i = 0; i < options.length; i++) {
                const char = String.fromCharCode(65 + i);
                checkboxContainer.innerHTML += `
                    <label><input type="checkbox" name="checkboxCorrect" value="${char}"> ${char}</label>
                `;
            }
        }

        function addQuestion() {
            const type = document.getElementById('questionType').value;
            const content = document.getElementById('questionContent').value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥é¢˜ç›®å†…å®¹');
                return;
            }
            
            let options = [];
            let correct = [];
            
            if (type !== 'text') {
                const optionInputs = document.querySelectorAll('#optionsContainer input[type="text"]');
                options = Array.from(optionInputs).map(input => input.value.trim());
                
                if (options.some(opt => !opt)) {
                    alert('è¯·å¡«å†™æ‰€æœ‰é€‰é¡¹å†…å®¹');
                    return;
                }
                
                if (type === 'radio') {
                    correct = [document.getElementById('radioCorrect').value];
                } else {
                    correct = Array.from(document.querySelectorAll('#checkboxAnswer input:checked'))
                                 .map(checkbox => checkbox.value);
                    if (correct.length === 0) {
                        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ');
                        return;
                    }
                }
            } else {
                const answer = document.getElementById('textCorrect').value.trim();
                if (!answer) {
                    alert('è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
                    return;
                }
                correct = [answer];
            }
            
            const newQuestion = {
                type,
                content,
                correct
            };
            
            if (type !== 'text') {
                newQuestion.options = options;
            }
            
            editorQuestions.push(newQuestion);
            updatePreview();
            clearEditor();
            alert('é¢˜ç›®å·²æ·»åŠ ï¼');
        }

        function updatePreview() {
            const preview = document.getElementById('questionPreview');
            const count = document.getElementById('questionCount');
            
            count.textContent = editorQuestions.length;
            preview.innerHTML = editorQuestions.map((q, index) => `
                <div style="margin-bottom:15px; padding:10px; border-bottom:1px solid var(--border-color);">
                    <strong>é¢˜ç›® ${index + 1}:</strong> ${q.content}
                    <div style="font-size:0.9em; color:#666;">
                        ç±»å‹: ${getQuestionTypeName(q.type)} | 
                        æ­£ç¡®ç­”æ¡ˆ: ${Array.isArray(q.correct) ? q.correct.join(', ') : q.correct}
                    </div>
                </div>
            `).join('');
        }

        function clearEditor() {
            document.getElementById('questionContent').value = '';
            document.getElementById('textCorrect').value = '';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = `
                <div class="option-item">
                    <input type="text" placeholder="é€‰é¡¹A">
                    <button onclick="removeOption(this)">åˆ é™¤</button>
                </div>
                <div class="option-item">
                    <input type="text" placeholder="é€‰é¡¹B">
                    <button onclick="removeOption(this)">åˆ é™¤</button>
                </div>
            `;
            
            updateAnswerOptions();
        }

        function generateJson() {
            if (editorQuestions.length === 0) {
                alert('è¯·å…ˆæ·»åŠ é¢˜ç›®');
                return;
            }
            
            const jsonStr = JSON.stringify(editorQuestions, null, 2);
            const jsonInput = document.getElementById('jsonInput');
            jsonInput.value = jsonStr;
            
            // åˆ‡æ¢åˆ°ç²˜è´´JSONæ ‡ç­¾
            switchTab('pasteTab');
            document.getElementById('importMenu').style.display = 'block';
            document.getElementById('visualEditor').style.display = 'none';
            
            alert('å·²ç”ŸæˆJSONæ•°æ®ï¼Œæ‚¨å¯ä»¥åœ¨"é—®AIè¦æ•°æ®"æ ‡ç­¾ä¸­æŸ¥çœ‹å’Œç¼–è¾‘');
        }

        function saveQuestions() {
            if (editorQuestions.length === 0) {
                alert('è¯·å…ˆæ·»åŠ é¢˜ç›®');
                return;
            }
            
            currentQuestions = [...editorQuestions];
            renderQuestions();
            alert(`å·²ä¿å­˜ ${editorQuestions.length} é“é¢˜ç›®ä¸ºå½“å‰è¯•å·`);
            document.getElementById('visualEditor').style.display = 'none';
        }

        // ================= æäº¤åŠŸèƒ½ =================
        function submitExam() {
            clearInterval(timerInterval);

            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('è¯·è¾“å…¥è€ƒç”Ÿå§“åï¼');
                return;
            }

            const { score, wrongQuestions } = calculateScore();
            const timeUsed = 30 * 60 - timeLeft;
            const minutesUsed = Math.floor(timeUsed / 60).toString().padStart(2, '0');
            const secondsUsed = (timeUsed % 60).toString().padStart(2, '0');
            const wrongQuestionNumbers = wrongQuestions.map(q => q.index + 1).join(', ');

            const resultMessage = `ğŸ‰è€ƒè¯•ç»“æŸï¼\n\nğŸ‘¤è€ƒç”Ÿå§“å: ${studentName}\nğŸ“Šå¾—åˆ†: ${score}/${currentQuestions.length}\nâ±ï¸ç”¨æ—¶: ${minutesUsed}:${secondsUsed}\nâŒç­”é”™é¢˜ç›®ç¼–å·: ${wrongQuestionNumbers || 'æ— '}`;
            alert(resultMessage);
            
            // é‡ç½®è€ƒè¯•çŠ¶æ€
            examStarted = false;
            updateExamControlButton();
            
            // ç¦ç”¨é¢˜ç›®å®¹å™¨
            document.getElementById('questionContainer').style.pointerEvents = 'none';
            document.getElementById('questionContainer').style.opacity = '0.6';
        }

        function calculateScore() {
            let score = 0;
            const wrongQuestions = [];

            currentQuestions.forEach((q, index) => {
                const correctAnswers = Array.isArray(q.correct) ? 
                    q.correct.map(a => a.toUpperCase()) : 
                    [q.correct.toUpperCase()];
                const userAnswers = getAnswers(index, q.type);

                if (arraysEqual(correctAnswers, userAnswers)) {
                    score++;
                } else {
                    wrongQuestions.push({
                        index,
                        question: q.content,
                        userAnswer: userAnswers,
                        correctAnswer: correctAnswers
                    });
                }
            });

            return { score, wrongQuestions };
        }

        function getAnswers(index, type) {
            if (type === 'text') {
                const input = document.querySelector(`input[data-question-id="${index}"]`);
                return [input.value.trim().toUpperCase()];
            }
            return Array.from(document.querySelectorAll(`input[name="q${index}"]:checked`))
                .map(el => el.value.toUpperCase());
        }

        // ================= å·¥å…·å‡½æ•° =================
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            const sortedA = [...a].sort();
            const sortedB = [...b].sort();
            return sortedA.every((val, i) => val === sortedB[i]);
        }
    </script>
</body>

</html>