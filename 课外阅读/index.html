<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½æ•™æé˜…è¯»å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f0f0f0;
            transition: all 0.3s;
            overflow: hidden;
        }

        .night-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        /* ä¾§è¾¹å¯¼èˆª */
        #sidebar {
            width: 280px;
            background: #fff;
            position: fixed;
            left: -280px;
            height: 100%;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        #sidebar.active {
            transform: translateX(280px);
        }

        /* å›¾ç‰‡å®¹å™¨ */
        #image-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 70px);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: inherit;
        }

        #image-viewer {
            width: 100%;
            height: 100%;
            overflow: auto;
            scroll-behavior: smooth;
            transform-origin: center center;
        }

        .page-image {
            max-width: 95%;
            max-height: 90vh;
            width: auto;
            height: auto;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            object-fit: contain;
            cursor: grab;
            display: block;
            background: white;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .left-controls, .center-controls, .right-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #page-indicator {
            color: white;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
        }

        /* ç›®å½•æ ·å¼ */
        .folder-title {
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .folder-title::before {
            content: 'ğŸ“‚';
            margin-right: 8px;
        }

        .book-item {
            padding: 12px 20px 12px 35px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-item::before {
            content: 'ğŸ“„';
            margin-right: 8px;
        }

        .book-item:hover {
            background: #f9f9f9;
        }

        .night-mode .book-item:hover {
            background: #333;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            text-align: center;
            padding: 50px;
            color: #ff4444;
        }

        /* æ‰¹æ³¨æ ·å¼ */
        .annotation {
            position: absolute;
            background: rgba(255,255,0,0.3);
            border: 1px dashed #ffcc00;
            z-index: 10;
        }

        /* ç¬”è®°æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
        .notes-active {
            color: #4CAF50 !important;
        }

        /* æ¨ªå±æç¤º */
        .orientation-alert {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* ç¼©æ”¾èœå• */
        .zoom-menu {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 101;
        }
        
        .zoom-menu.active {
            display: flex;
        }

        /* ç¬”è®°æ¨¡æ€æ¡† */
        .notes-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #notes-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        
        .notes-history {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .note-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .note-content {
            margin-bottom: 5px;
        }
        
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .note-actions {
            margin-top: 5px;
            display: flex;
            gap: 5px;
        }
        
        .note-actions button {
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            background: #e0e0e0;
        }

        /* è·³è½¬é¡µé¢æ¨¡æ€æ¡† */
        .jump-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        #jump-page-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        /* é®ç½©å±‚ */
        .sidebar-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            display: none;
        }

        /* éŸ³é¢‘æ§åˆ¶æ  */
        .audio-controls {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 25px;
            padding: 12px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .audio-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .audio-progress-bar {
            position: absolute;
            height: 100%;
            background: #2196F3;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .audio-time {
            color: white;
            font-size: 12px;
            min-width: 100px;
            text-align: center;
        }

        #play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #play-btn:hover {
            transform: scale(1.1);
        }

        /* å¤œé—´æ¨¡å¼é€‚é… */
        .night-mode .audio-controls {
            background: rgba(255,255,255,0.1);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .page-image {
                max-width: 100%;
                padding: 10px;
            }
            
            #image-container {
                height: calc(100vh - 60px);
            }
            
            .audio-controls {
                bottom: 60px;
                right: 10px;
                padding: 8px;
                gap: 10px;
            }
            
            .audio-progress {
                width: 150px;
            }
        }

        @media screen and (orientation: landscape) {
            .orientation-alert {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹å¯¼èˆª -->
    <aside id="sidebar">
        <div id="directory"></div>
    </aside>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div id="image-container">
        <div id="image-viewer"></div>
    </div>
    
    <!-- åº•éƒ¨æ§åˆ¶æ  -->
    <div class="controls">
        <div class="left-controls">
            <button id="menu-btn">â˜°</button>
            <button id="zoom-btn">ğŸ”</button>
            <div class="zoom-menu" id="zoom-menu">
                <button id="zoom-in">+</button>
                <button id="zoom-reset">â†»</button>
                <button id="zoom-out">-</button>
                <button id="jump-btn">è·³é¡µ</button>
            </div>
        </div>
        
        <div class="center-controls">
            <button id="prev-page">â†</button>
            <span id="page-indicator">-/-</span>
            <button id="next-page">â†’</button>
        </div>
        
        <div class="right-controls">
            <button id="notes-btn">ğŸ“</button>
            <button id="night-mode">ğŸŒ™</button>
        </div>
    </div>

    <!-- éŸ³é¢‘æ§åˆ¶æ  -->
    <div class="audio-controls" id="audio-controls">
        <button id="play-btn">â–¶</button>
        <div class="audio-time" id="audio-time">0:00 / 0:00</div>
        <div class="audio-progress" id="audio-progress">
            <div class="audio-progress-bar" id="audio-progress-bar"></div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="loader" id="loader"></div>

    <!-- æ¨ªå±æç¤º -->
    <div class="orientation-alert">
        <h2>è¯·åˆ‡æ¢åˆ°ç«–å±æ¨¡å¼</h2>
        <p>ä¸ºäº†æ›´å¥½çš„é˜…è¯»ä½“éªŒï¼Œå»ºè®®ä½¿ç”¨ç«–å±æµè§ˆ</p>
    </div>

    <!-- ç¬”è®°æ¨¡æ€æ¡† -->
    <div class="notes-modal" id="notes-modal" style="display: none;">
        <div class="notes-header">
            <h3>é˜…è¯»ç¬”è®° (ç¬¬<span id="current-note-page"></span>é¡µ)</h3>
            <button onclick="closeNotesModal()">Ã—</button>
        </div>
        <textarea id="notes-content" placeholder="å†™ä¸‹ä½ çš„æ€è€ƒæˆ–æ„Ÿæƒ³..."></textarea>
        <button onclick="saveNote()" style="width: 100%; padding: 10px; margin-bottom: 10px;">ä¿å­˜ç¬”è®°</button>
        
        <div class="notes-history" id="notes-history"></div>
    </div>

    <!-- è·³è½¬é¡µé¢æ¨¡æ€æ¡† -->
    <div class="jump-modal" id="jump-modal" style="display: none;">
        <div class="notes-header">
            <h3>è·³è½¬åˆ°æŒ‡å®šé¡µé¢</h3>
            <button onclick="closeJumpModal()">Ã—</button>
        </div>
        <input type="number" id="jump-page-input" min="1" placeholder="è¾“å…¥é¡µç ">
        <button onclick="jumpToPage()" style="width: 100%; padding: 10px;">è·³è½¬</button>
        <p style="text-align: center; margin-top: 10px; color: #666;">
            å…± <span id="total-pages-display">0</span> é¡µ
        </p>
    </div>

    <!-- é®ç½©å±‚ -->
    <div id="sidebar-mask" class="sidebar-mask"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // é…ç½®ä¿¡æ¯
        const config = {
            basePath: './books/',
            supportedFormats: ['jpg', 'png', 'jpeg'],
            books: {
                "å°å­¦è¯­æ–‡": {
                    type: 'folder',
                    children: {
                        "å°å­¦ç”Ÿå¿…èƒŒå¤è¯—": {
                            type: 'book',
                            pages: 194,
                            path: 'chinese-poetry/{page}',
                            audioPath: 'audios/poetry/{page}.mp3'
                        },
                        "ä½œæ–‡èŒƒæ–‡": {
                            type: 'book',
                            pages: 36,
                            path: 'chinese-essay/{page}'
                        }
                    }
                }
            },
            // Firebaseé…ç½®ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®é™…é…ç½®ï¼‰
            firebase: {
                apiKey: "AIzaSyABC123XYZ456DEF789GHI",
                authDomain: "your-project-id.firebaseapp.com",
                databaseURL: "https://your-project-id.firebaseio.com",
                projectId: "your-project-id",
                storageBucket: "your-project-id.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abc123def456ghi789jkl"
            }
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(config.firebase);
        const database = firebase.database();

        // å…¨å±€çŠ¶æ€
        let currentBook = null;
        let currentPage = 1;
        let currentTotalPages = 0;
        let currentFilePattern = { padLength: 1, format: 'jpg' };
        let scale = 1;
        let annotations = [];
        let notes = JSON.parse(localStorage.getItem('localNotes')) || {};
        let isSelectingText = false;
        let selectionStart = null;
        let currentNoteKey = null;
        let audioElement = null;
        let currentAudioPage = 0;

        // åˆå§‹åŒ–
        async function init() {
            renderDirectory();
            initEvents();
            loadLastPosition();
            checkOrientation();
            setupFirebaseListeners();
            
            if (localStorage.getItem('nightMode') === 'true') {
                document.body.classList.add('night-mode');
            }
        }

        // è®¾ç½®Firebaseç›‘å¬
        function setupFirebaseListeners() {
            database.ref('notes').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                
                // æ›´æ–°æœ¬åœ°ç¬”è®°æ•°æ®
                Object.entries(data).forEach(([key, note]) => {
                    if (!notes[note.book]) notes[note.book] = {};
                    if (!notes[note.book][note.page]) notes[note.book][note.page] = [];
                    
                    const existingIndex = notes[note.book][note.page].findIndex(n => n.key === key);
                    if (existingIndex >= 0) {
                        notes[note.book][note.page][existingIndex] = { ...note, key };
                    } else {
                        notes[note.book][note.page].push({ ...note, key });
                    }
                });
                
                localStorage.setItem('localNotes', JSON.stringify(notes));
                
                // å¦‚æœå½“å‰æ‰“å¼€äº†ç¬”è®°æ¨¡æ€æ¡†ï¼Œåˆ·æ–°æ˜¾ç¤º
                if (document.getElementById('notes-modal').style.display === 'block') {
                    showNotesModal();
                }
                
                // æ›´æ–°ç›®å½•ä¸­çš„ç¬”è®°æ ‡è®°
                renderDirectory();
            });
        }

        // æ¸²æŸ“ç›®å½•
        function renderDirectory() {
            const container = document.getElementById('directory');
            container.innerHTML = buildTree(config.books);
        }

        // ç”Ÿæˆç›®å½•HTML
        function buildTree(data) {
            return Object.entries(data).map(([name, info]) => {
                if (info.type === 'folder') {
                    return `
                        <div class="folder">
                            <div class="folder-title">${name}</div>
                            <div class="folder-content">
                                ${buildTree(info.children)}
                            </div>
                        </div>
                    `;
                }
                const hasNotes = notes[info.path] && Object.values(notes[info.path]).some(p => p.length > 0);
                return `
                    <div class="book-item" 
                         data-path="${info.path}"
                         data-pages="${info.pages}">
                        ${name} (å…±${info.pages}é¡µ)
                        ${hasNotes ? 'ğŸ“' : ''}
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½ä¹¦ç±
        async function loadBook(pathPattern, totalPages) {
            try {
                showLoader(true);
                clearAnnotations();
                stopAudio();
                
                currentBook = pathPattern;
                currentPage = 1;
                currentTotalPages = totalPages;
                
                // æ£€æµ‹æ–‡ä»¶å‘½åè§„åˆ™
                currentFilePattern = await detectFilePattern(pathPattern);
                
                // ç«‹å³åŠ è½½å¹¶æ˜¾ç¤ºç¬¬ä¸€é¡µ
                await loadAndRenderPage(currentPage);
                
                // å¼‚æ­¥é¢„åŠ è½½å…¶ä»–é¡µ
                setTimeout(() => preloadAdjacentPages(), 100);
                
                updatePageIndicator();
                savePosition();
                checkNotes();
            } catch (err) {
                console.error('ä¹¦ç±åŠ è½½å¤±è´¥:', err);
                showError(`æ— æ³•åŠ è½½ä¹¦ç±ï¼š${err.message}`);
            } finally {
                showLoader(false);
            }
        }

        // æ£€æµ‹æ–‡ä»¶å‘½åè§„åˆ™
        async function detectFilePattern(pathPattern) {
            const testPage = 1;
            
            // æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„ç»„åˆ
            for (const padLength of [1, 2, 3]) {
                for (const format of config.supportedFormats) {
                    const url = buildImageUrl(pathPattern, testPage, padLength, format);
                    try {
                        const exists = await checkFileExists(url);
                        if (exists) {
                            console.log('æ£€æµ‹åˆ°æ–‡ä»¶æ ¼å¼:', {padLength, format});
                            return {padLength, format};
                        }
                    } catch (e) {
                        console.debug(`æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: ${url}`);
                    }
                }
            }
            
            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
        }

        // æ„å»ºå›¾ç‰‡URL
        function buildImageUrl(pattern, page, padLength, format) {
            const padded = page.toString().padStart(padLength, '0');
            return `${config.basePath}${pattern.replace('{page}', padded)}.${format}`;
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        function checkFileExists(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // åŠ è½½å¹¶æ¸²æŸ“å•é¡µ
        async function loadAndRenderPage(page) {
            try {
                const url = getPageUrl(page);
                const img = await loadImage(url);
                renderPage(img, page);
                checkAndLoadAudio(currentBook, page);
            } catch (err) {
                console.error(`ç¬¬${page}é¡µåŠ è½½å¤±è´¥:`, err);
                showError(`ç¬¬${page}é¡µåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶`);
                throw err;
            }
        }

        // åŠ è½½å›¾ç‰‡
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    resolve(img);
                    setTimeout(adjustImageSize, 100); // å»¶è¿Ÿç¡®ä¿å›¾ç‰‡å·²æ¸²æŸ“
                };
                img.onerror = () => reject(new Error(`åŠ è½½å¤±è´¥: ${url}`));
                img.src = url;
            });
        }

        // æ¸²æŸ“å½“å‰é¡µ
        function renderPage(img, page) {
            const container = document.getElementById('image-viewer');
            container.innerHTML = '';
            
            if (!img) {
                container.innerHTML = `
                    <div class="error-message">
                        <p>å›¾ç‰‡åŠ è½½å¤±è´¥</p>
                        <button onclick="retryCurrentPage()">é‡è¯•</button>
                    </div>
                `;
                return;
            }
            
            const imgClone = img.cloneNode();
            imgClone.className = 'page-image';
            container.appendChild(imgClone);
            
            // æ¢å¤æ‰¹æ³¨
            restoreAnnotations(page);
            
            // è°ƒæ•´å›¾ç‰‡å¤§å°
            adjustImageSize();
        }

        // è°ƒæ•´å›¾ç‰‡å¤§å°
        function adjustImageSize() {
            const container = document.getElementById('image-container');
            const img = document.querySelector('.page-image');
            if (!img) return;

            // è®¡ç®—å¯ç”¨ç©ºé—´
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // è®¡ç®—æœ€ä½³ç¼©æ”¾æ¯”ä¾‹
            const widthRatio = containerWidth / img.naturalWidth;
            const heightRatio = containerHeight / img.naturalHeight;
            const minRatio = Math.min(widthRatio, heightRatio);
            
            // åº”ç”¨è‡ªåŠ¨ç¼©æ”¾
            scale = Math.min(minRatio, 1); // åˆå§‹ä¸æ”¾å¤§è¶…è¿‡100%
            applyZoom();
        }

        // é¢„åŠ è½½å‰åé¡µ
        function preloadAdjacentPages() {
            if (!currentBook) return;
            
            const start = Math.max(1, currentPage - 3);
            const end = Math.min(currentTotalPages, currentPage + 3);
            
            for (let i = start; i <= end; i++) {
                if (i !== currentPage) {
                    const url = getPageUrl(i);
                    new Image().src = url; // é™é»˜é¢„åŠ è½½
                }
            }
        }

        // è·å–å½“å‰é¡µURL
        function getPageUrl(page) {
            return buildImageUrl(
                currentBook,
                page,
                currentFilePattern.padLength,
                currentFilePattern.format
            );
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const container = document.getElementById('image-viewer');
            container.innerHTML = `
                <div class="error-message">
                    <p>${message}</p>
                    <button onclick="retryCurrentBook()">é‡æ–°åŠ è½½</button>
                </div>
            `;
        }

        // æ›´æ–°é¡µç æ˜¾ç¤º
        function updatePageIndicator() {
            document.getElementById('page-indicator').textContent = 
                `${currentPage}/${currentTotalPages}`;
        }

        // ä¿å­˜é˜…è¯»ä½ç½®
        function savePosition() {
            if (currentBook) {
                localStorage.setItem('lastPosition', JSON.stringify({
                    bookPath: currentBook,
                    page: currentPage,
                    totalPages: currentTotalPages,
                    pattern: currentFilePattern
                }));
            }
        }

        // åŠ è½½æœ€åé˜…è¯»ä½ç½®
        function loadLastPosition() {
            const saved = localStorage.getItem('lastPosition');
            if (saved) {
                const { bookPath, page, totalPages, pattern } = JSON.parse(saved);
                currentFilePattern = pattern;
                loadBook(bookPath, totalPages).then(() => {
                    currentPage = Math.min(page, totalPages);
                    loadAndRenderPage(currentPage);
                });
            }
        }

        // æ£€æŸ¥å½“å‰é¡µç¬”è®°
        function checkNotes() {
            const notesBtn = document.getElementById('notes-btn');
            if (notes[currentBook] && notes[currentBook][currentPage] && notes[currentBook][currentPage].length > 0) {
                notesBtn.classList.add('notes-active');
            } else {
                notesBtn.classList.remove('notes-active');
            }
        }

        // éŸ³é¢‘æ§åˆ¶é€»è¾‘
        function checkAndLoadAudio(bookPath, page) {
            const audioControls = document.getElementById('audio-controls');
            const bookConfig = findBookConfig(bookPath);
            
            if (bookConfig && bookConfig.audioPath) {
                const audioUrl = `${config.basePath}${bookConfig.audioPath.replace('{page}', page)}`;
                initAudioPlayer(audioUrl, page);
                audioControls.style.display = 'flex';
            } else {
                audioControls.style.display = 'none';
                stopAudio();
            }
        }

        function findBookConfig(path) {
            // é€’å½’æŸ¥æ‰¾åŒ¹é…çš„ä¹¦ç±é…ç½®
            function search(books) {
                for (const key in books) {
                    const item = books[key];
                    if (item.path === path) return item;
                    if (item.children) {
                        const result = search(item.children);
                        if (result) return result;
                    }
                }
                return null;
            }
            return search(config.books);
        }

        function initAudioPlayer(url, page) {
            // æ¸…ç†ä¹‹å‰çš„éŸ³é¢‘
            stopAudio();
            currentAudioPage = page;

            audioElement = new Audio(url);
            
            // äº‹ä»¶ç›‘å¬
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('loadedmetadata', () => {
                document.getElementById('audio-time').textContent = 
                    `0:00 / ${formatTime(audioElement.duration)}`;
            });
            audioElement.addEventListener('ended', () => {
                document.getElementById('play-btn').textContent = 'â–¶';
            });

            // è¿›åº¦æ¡äº¤äº’
            const progress = document.getElementById('audio-progress');
            progress.addEventListener('click', (e) => {
                const rect = progress.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioElement.currentTime = percent * audioElement.duration;
            });
        }

        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement = null;
                document.getElementById('play-btn').textContent = 'â–¶';
            }
        }

        // è¾…åŠ©å‡½æ•°
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            const progressBar = document.getElementById('audio-progress-bar');
            const percent = (audioElement.currentTime / audioElement.duration) * 100;
            progressBar.style.width = `${percent}%`;
            
            document.getElementById('audio-time').textContent = 
                `${formatTime(audioElement.currentTime)} / ${formatTime(audioElement.duration)}`;
        }

        // æ˜¾ç¤ºç¬”è®°æ¨¡æ€æ¡†
        function showNotesModal() {
            if (!currentBook) return;
            
            const modal = document.getElementById('notes-modal');
            const pageNotes = notes[currentBook] && notes[currentBook][currentPage] ? 
                notes[currentBook][currentPage] : [];
            
            // æ˜¾ç¤ºå½“å‰é¡µç¬”è®°
            document.getElementById('current-note-page').textContent = currentPage;
            
            // å¦‚æœæœ‰ç¬”è®°ï¼Œæ˜¾ç¤ºæœ€æ–°çš„ä¸€æ¡
            if (pageNotes.length > 0) {
                const latestNote = pageNotes.reduce((prev, current) => 
                    (prev.timestamp > current.timestamp) ? prev : current);
                document.getElementById('notes-content').value = latestNote.content;
                currentNoteKey = latestNote.key;
            } else {
                document.getElementById('notes-content').value = '';
                currentNoteKey = null;
            }
            
            // æ˜¾ç¤ºå†å²è®°å½•
            const historyContainer = document.getElementById('notes-history');
            if (pageNotes.length > 0) {
                historyContainer.innerHTML = pageNotes
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .map(note => `
                        <div class="note-item">
                            <div class="note-content">${note.content}</div>
                            <div class="note-meta">
                                <span>${new Date(note.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="note-actions">
                                <button onclick="editNote('${note.key}')">ç¼–è¾‘</button>
                                <button onclick="deleteNote('${note.key}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
            } else {
                historyContainer.innerHTML = '<p>æš‚æ— å†å²ç¬”è®°</p>';
            }
            
            modal.style.display = 'block';
        }

        // ä¿å­˜ç¬”è®°
        async function saveNote() {
            const content = document.getElementById('notes-content').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥ç¬”è®°å†…å®¹');
                return;
            }

            try {
                const noteData = {
                    content,
                    timestamp: Date.now(),
                    book: currentBook,
                    page: currentPage
                };

                // å¦‚æœæœ‰æ­£åœ¨ç¼–è¾‘çš„ç¬”è®°ï¼Œæ›´æ–°å®ƒï¼›å¦åˆ™åˆ›å»ºæ–°ç¬”è®°
                if (currentNoteKey) {
                    await database.ref(`notes/${currentNoteKey}`).update(noteData);
                } else {
                    const newNoteRef = database.ref('notes').push();
                    await newNoteRef.set(noteData);
                    currentNoteKey = newNoteRef.key;
                }

                // æ›´æ–°æœ¬åœ°çŠ¶æ€
                if (!notes[currentBook]) notes[currentBook] = {};
                if (!notes[currentBook][currentPage]) notes[currentBook][currentPage] = [];
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç¬”è®°
                const existingIndex = notes[currentBook][currentPage].findIndex(n => n.key === currentNoteKey);
                if (existingIndex >= 0) {
                    notes[currentBook][currentPage][existingIndex] = { ...noteData, key: currentNoteKey };
                } else {
                    notes[currentBook][currentPage].push({ ...noteData, key: currentNoteKey });
                }
                
                localStorage.setItem('localNotes', JSON.stringify(notes));
                
                // æ›´æ–°UI
                checkNotes();
                showNotesModal();
            } catch (error) {
                console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
                alert('ä¿å­˜ç¬”è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç¼–è¾‘ç¬”è®°
        function editNote(noteKey) {
            const note = notes[currentBook][currentPage].find(n => n.key === noteKey);
            if (note) {
                document.getElementById('notes-content').value = note.content;
                currentNoteKey = noteKey;
                document.getElementById('notes-content').focus();
            }
        }

        // åˆ é™¤ç¬”è®°
        async function deleteNote(noteKey) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
                try {
                    // åˆ é™¤äº‘ç«¯æ•°æ®
                    await database.ref(`notes/${noteKey}`).remove();
                    
                    // åˆ é™¤æœ¬åœ°æ•°æ®
                    notes[currentBook][currentPage] = notes[currentBook][currentPage].filter(n => n.key !== noteKey);
                    localStorage.setItem('localNotes', JSON.stringify(notes));
                    
                    // æ›´æ–°UI
                    if (notes[currentBook][currentPage].length === 0) {
                        document.getElementById('notes-btn').classList.remove('notes-active');
                    }
                    
                    showNotesModal();
                } catch (error) {
                    console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
                    alert('åˆ é™¤ç¬”è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            }
        }

        // å…³é—­ç¬”è®°æ¨¡æ€æ¡†
        function closeNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºè·³è½¬é¡µé¢æ¨¡æ€æ¡†
        function showJumpModal() {
            if (!currentBook) return;
            
            const modal = document.getElementById('jump-modal');
            document.getElementById('jump-page-input').value = currentPage;
            document.getElementById('jump-page-input').max = currentTotalPages;
            document.getElementById('total-pages-display').textContent = currentTotalPages;
            modal.style.display = 'block';
            document.getElementById('jump-page-input').focus();
        }

        // å…³é—­è·³è½¬é¡µé¢æ¨¡æ€æ¡†
        function closeJumpModal() {
            document.getElementById('jump-modal').style.display = 'none';
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function jumpToPage() {
            const input = document.getElementById('jump-page-input');
            let page = parseInt(input.value);
            
            if (isNaN(page) || page < 1 || page > currentTotalPages) {
                alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${currentTotalPages})`);
                return;
            }
            
            currentPage = page;
            loadAndRenderPage(currentPage);
            updatePageIndicator();
            savePosition();
            checkNotes();
            closeJumpModal();
        }

        // æ‰¹æ³¨åŠŸèƒ½
        function initTextSelection() {
            const container = document.getElementById('image-viewer');
            
            container.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'IMG') {
                    isSelectingText = true;
                    const rect = e.target.getBoundingClientRect();
                    selectionStart = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (isSelectingText && selectionStart) {
                    clearAnnotations();
                    
                    const img = document.querySelector('.page-image');
                    const rect = img.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    
                    // åˆ›å»ºä¸´æ—¶æ‰¹æ³¨
                    const annotation = document.createElement('div');
                    annotation.className = 'annotation';
                    annotation.style.left = `${Math.min(selectionStart.x, endX)}px`;
                    annotation.style.top = `${Math.min(selectionStart.y, endY)}px`;
                    annotation.style.width = `${Math.abs(endX - selectionStart.x)}px`;
                    annotation.style.height = `${Math.abs(endY - selectionStart.y)}px`;
                    
                    container.appendChild(annotation);
                }
            });
            
            container.addEventListener('mouseup', (e) => {
                if (isSelectingText && selectionStart) {
                    const img = document.querySelector('.page-image');
                    const rect = img.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    
                    if (Math.abs(endX - selectionStart.x) > 10 && 
                        Math.abs(endY - selectionStart.y) > 10) {
                        // ä¿å­˜æ‰¹æ³¨
                        saveAnnotation(
                            currentPage,
                            selectionStart.x,
                            selectionStart.y,
                            endX - selectionStart.x,
                            endY - selectionStart.y
                        );
                    }
                    
                    isSelectingText = false;
                    selectionStart = null;
                }
            });
        }

        // ä¿å­˜æ‰¹æ³¨
        function saveAnnotation(page, x, y, width, height) {
            if (!annotations[currentBook]) {
                annotations[currentBook] = {};
            }
            
            if (!annotations[currentBook][page]) {
                annotations[currentBook][page] = [];
            }
            
            annotations[currentBook][page].push({ x, y, width, height });
            localStorage.setItem('annotations', JSON.stringify(annotations));
            restoreAnnotations(page);
        }

        // æ¢å¤æ‰¹æ³¨
        function restoreAnnotations(page) {
            if (!annotations[currentBook] || !annotations[currentBook][page]) return;
            
            const container = document.getElementById('image-viewer');
            annotations[currentBook][page].forEach(ann => {
                const annotation = document.createElement('div');
                annotation.className = 'annotation';
                annotation.style.left = `${ann.x}px`;
                annotation.style.top = `${ann.y}px`;
                annotation.style.width = `${ann.width}px`;
                annotation.style.height = `${ann.height}px`;
                container.appendChild(annotation);
            });
        }

        // æ¸…é™¤æ‰¹æ³¨
        function clearAnnotations() {
            document.querySelectorAll('.annotation').forEach(el => el.remove());
        }

        // ç¼©æ”¾åŠŸèƒ½
        function applyZoom() {
            const img = document.querySelector('.page-image');
            if (img) {
                img.style.width = `${img.naturalWidth * scale}px`;
                img.style.height = `${img.naturalHeight * scale}px`;
                centerImage();
            }
        }

        // ä¿æŒå›¾ç‰‡å±…ä¸­
        function centerImage() {
            const container = document.getElementById('image-viewer');
            const img = document.querySelector('.page-image');
            if (img) {
                const offsetX = (container.offsetWidth - img.offsetWidth) / 2;
                const offsetY = (container.offsetHeight - img.offsetHeight) / 2;
                container.scrollTo(offsetX, offsetY);
            }
        }

        // æ¨ªå±æ£€æµ‹
        function checkOrientation() {
            function handleOrientationChange() {
                if (window.matchMedia("(orientation: portrait)").matches) {
                    document.querySelector('.orientation-alert').style.display = 'none';
                } else {
                    document.querySelector('.orientation-alert').style.display = 'flex';
                }
            }
            
            window.addEventListener('resize', handleOrientationChange);
            handleOrientationChange();
        }

        // äº‹ä»¶å¤„ç†
        function initEvents() {
            // èœå•æŒ‰é’®
            document.getElementById('menu-btn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const mask = document.getElementById('sidebar-mask');
                
                if (sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mask.style.display = 'none';
                } else {
                    sidebar.classList.add('active');
                    mask.style.display = 'block';
                }
            });

            // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
            document.getElementById('sidebar-mask').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-mask').style.display = 'none';
            });

            // é˜²æ­¢ç‚¹å‡»ä¾§è¾¹æ å†…éƒ¨è§¦å‘é®ç½©å±‚å…³é—­
            document.getElementById('sidebar').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // ESCé”®å…³é—­ä¾§è¾¹æ 
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebar-mask').style.display = 'none';
                }
            });

            // ç›®å½•é¡¹ç‚¹å‡»
            document.getElementById('directory').addEventListener('click', (e) => {
                const item = e.target.closest('.book-item');
                if (item) {
                    const path = item.dataset.path;
                    const pages = parseInt(item.dataset.pages);
                    loadBook(path, pages);
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebar-mask').style.display = 'none';
                }
            });

            // ç¿»é¡µæ§åˆ¶
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAndRenderPage(currentPage);
                    preloadAdjacentPages();
                    updatePageIndicator();
                    savePosition();
                    checkNotes();
                    stopAudio();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < currentTotalPages) {
                    currentPage++;
                    loadAndRenderPage(currentPage);
                    preloadAdjacentPages();
                    updatePageIndicator();
                    savePosition();
                    checkNotes();
                    stopAudio();
                }
            });

            // è§¦å±æ»‘åŠ¨
            let touchStartX = 0;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                }
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (e.changedTouches.length !== 1) return;
                
                const diff = touchStartX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentPage < currentTotalPages) {
                        currentPage++;
                        loadAndRenderPage(currentPage);
                        updatePageIndicator();
                        savePosition();
                        checkNotes();
                        stopAudio();
                    } else if (diff < 0 && currentPage > 1) {
                        currentPage--;
                        loadAndRenderPage(currentPage);
                        updatePageIndicator();
                        savePosition();
                        checkNotes();
                        stopAudio();
                    }
                }
            }, { passive: true });

            // åŒæŒ‡ç¼©æ”¾
            let initialDistance = null;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && initialDistance) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const newScale = scale * (currentDistance / initialDistance);
                    scale = Math.min(Math.max(newScale, 0.5), 3);
                    applyZoom();
                }
            }, { passive: false });

            document.addEventListener('touchend', () => {
                initialDistance = null;
            });

            // ç¬”è®°æŒ‰é’®
            document.getElementById('notes-btn').addEventListener('click', showNotesModal);

            // ç¼©æ”¾æ§åˆ¶
            document.getElementById('zoom-btn').addEventListener('click', () => {
                document.getElementById('zoom-menu').classList.toggle('active');
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                scale = Math.min(scale + 0.1, 3);
                applyZoom();
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                scale = Math.max(scale - 0.1, 0.5);
                applyZoom();
            });

            document.getElementById('zoom-reset').addEventListener('click', () => {
                adjustImageSize();
                document.getElementById('zoom-menu').classList.remove('active');
            });

            // è·³è½¬é¡µé¢æŒ‰é’®
            document.getElementById('jump-btn').addEventListener('click', showJumpModal);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç¼©æ”¾èœå•
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#zoom-btn') && !e.target.closest('#zoom-menu')) {
                    document.getElementById('zoom-menu').classList.remove('active');
                }
            });

            // å¤œé—´æ¨¡å¼
            document.getElementById('night-mode').addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                localStorage.setItem('nightMode', 
                    document.body.classList.contains('night-mode'));
            });

            // è·³è½¬é¡µé¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('jump-page-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });

            // æ’­æ”¾æŒ‰é’®æ§åˆ¶
            document.getElementById('play-btn').addEventListener('click', function() {
                if (!audioElement) return;

                if (audioElement.paused) {
                    audioElement.play();
                    this.textContent = 'â¸';
                } else {
                    audioElement.pause();
                    this.textContent = 'â–¶';
                }
            });

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾ç‰‡
            window.addEventListener('resize', () => {
                adjustImageSize();
                centerImage();
            });

            // åˆå§‹åŒ–æ–‡æœ¬é€‰æ‹©æ‰¹æ³¨
            initTextSelection();
        }

        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // é‡è¯•å½“å‰é¡µ
        function retryCurrentPage() {
            loadAndRenderPage(currentPage);
        }

        // é‡è¯•å½“å‰ä¹¦ç±
        function retryCurrentBook() {
            if (currentBook) {
                loadBook(currentBook, currentTotalPages);
            }
        }

        // å…¨å±€å‡½æ•°
        window.retryCurrentPage = retryCurrentPage;
        window.retryCurrentBook = retryCurrentBook;
        window.loadBook = loadBook;
        window.showNotesModal = showNotesModal;
        window.closeNotesModal = closeNotesModal;
        window.saveNote = saveNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        window.showJumpModal = showJumpModal;
        window.closeJumpModal = closeJumpModal;
        window.jumpToPage = jumpToPage;

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>