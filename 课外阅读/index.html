<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫ËÉΩÊïôÊùêÈòÖËØªÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: #f0f0f0;
            transition: all 0.3s;
            overflow: hidden;
        }

        .night-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        /* ‰æßËæπÂØºËà™ */
        #sidebar {
            width: 280px;
            background: #fff;
            position: fixed;
            left: -280px;
            height: 100%;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        #sidebar.active {
            transform: translateX(280px);
        }

        /* ÂõæÁâáÂÆπÂô® */
        #image-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 70px);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: inherit;
        }

        #image-viewer {
            width: 100%;
            height: 100%;
            overflow: auto;
            scroll-behavior: smooth;
            transform-origin: center center;
        }

        .page-image {
            max-width: 95%;
            max-height: 90vh;
            width: auto;
            height: auto;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            object-fit: contain;
            cursor: grab;
            display: block;
            background: white;
        }

        /* Âä†ËΩΩÊåáÁ§∫Âô® */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Â∫ïÈÉ®ÊéßÂà∂Ê†è */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .left-controls, .center-controls, .right-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #page-indicator {
            color: white;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
        }

        /* ÁõÆÂΩïÊ†∑Âºè */
        .folder-title {
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .folder-title::before {
            content: 'üìÇ';
            margin-right: 8px;
        }

        .book-item {
            padding: 12px 20px 12px 35px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-item::before {
            content: 'üìÑ';
            margin-right: 8px;
        }

        .book-item:hover {
            background: #f9f9f9;
        }

        .night-mode .book-item:hover {
            background: #333;
        }

        /* ÈîôËØØÊèêÁ§∫ */
        .error-message {
            text-align: center;
            padding: 50px;
            color: #ff4444;
        }

        /* ÊâπÊ≥®Ê†∑Âºè */
        .annotation {
            position: absolute;
            background: rgba(255,255,0,0.3);
            border: 1px dashed #ffcc00;
            z-index: 10;
        }

        /* Á¨îËÆ∞ÊåâÈíÆÊøÄÊ¥ªÁä∂ÊÄÅ */
        .notes-active {
            color: #4CAF50 !important;
        }

        /* Ê®™Â±èÊèêÁ§∫ */
        .orientation-alert {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* Áº©ÊîæËèúÂçï */
        .zoom-menu {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 101;
        }
        
        .zoom-menu.active {
            display: flex;
        }

        /* Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü */
        .notes-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #notes-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        
        .notes-history {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .note-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .note-content {
            margin-bottom: 5px;
        }
        
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .note-actions {
            margin-top: 5px;
            display: flex;
            gap: 5px;
        }
        
        .note-actions button {
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            background: #e0e0e0;
        }

        /* Ë∑≥ËΩ¨È°µÈù¢Ê®°ÊÄÅÊ°Ü */
        .jump-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        #jump-page-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        /* ÈÅÆÁΩ©Â±Ç */
        .sidebar-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            display: none;
        }

        /* Èü≥È¢ëÊéßÂà∂Ê†è */
        .audio-controls {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 25px;
            padding: 12px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .audio-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .audio-progress-bar {
            position: absolute;
            height: 100%;
            background: #2196F3;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .audio-time {
            color: white;
            font-size: 12px;
            min-width: 100px;
            text-align: center;
        }

        #play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #play-btn:hover {
            transform: scale(1.1);
        }

        /* Â§úÈó¥Ê®°ÂºèÈÄÇÈÖç */
        .night-mode .audio-controls {
            background: rgba(255,255,255,0.1);
        }

        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .page-image {
                max-width: 100%;
                padding: 10px;
            }
            
            #image-container {
                height: calc(100vh - 60px);
            }
            
            .audio-controls {
                bottom: 60px;
                right: 10px;
                padding: 8px;
                gap: 10px;
            }
            
            .audio-progress {
                width: 150px;
            }
        }

        @media screen and (orientation: landscape) {
            .orientation-alert {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- ‰æßËæπÂØºËà™ -->
    <aside id="sidebar">
        <div id="directory"></div>
    </aside>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div id="image-container">
        <div id="image-viewer"></div>
    </div>
    
    <!-- Â∫ïÈÉ®ÊéßÂà∂Ê†è -->
    <div class="controls">
        <div class="left-controls">
            <button id="menu-btn">‚ò∞</button>
            <button id="zoom-btn">üîç</button>
            <div class="zoom-menu" id="zoom-menu">
                <button id="zoom-in">+</button>
                <button id="zoom-reset">‚Üª</button>
                <button id="zoom-out">-</button>
                <button id="jump-btn">Ë∑≥È°µ</button>
            </div>
        </div>
        
        <div class="center-controls">
            <button id="prev-page">‚Üê</button>
            <span id="page-indicator">-/-</span>
            <button id="next-page">‚Üí</button>
        </div>
        
        <div class="right-controls">
            <button id="notes-btn">üìù</button>
            <button id="night-mode">üåô</button>
        </div>
    </div>

    <!-- Èü≥È¢ëÊéßÂà∂Ê†è -->
    <div class="audio-controls" id="audio-controls">
        <button id="play-btn">‚ñ∂</button>
        <div class="audio-time" id="audio-time">0:00 / 0:00</div>
        <div class="audio-progress" id="audio-progress">
            <div class="audio-progress-bar" id="audio-progress-bar"></div>
        </div>
    </div>

    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
    <div class="loader" id="loader"></div>

    <!-- Ê®™Â±èÊèêÁ§∫ -->
    <div class="orientation-alert">
        <h2>ËØ∑ÂàáÊç¢Âà∞Á´ñÂ±èÊ®°Âºè</h2>
        <p>‰∏∫‰∫ÜÊõ¥Â•ΩÁöÑÈòÖËØª‰ΩìÈ™åÔºåÂª∫ËÆÆ‰ΩøÁî®Á´ñÂ±èÊµèËßà</p>
    </div>

    <!-- Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü -->
    <div class="notes-modal" id="notes-modal" style="display: none;">
        <div class="notes-header">
            <h3>ÈòÖËØªÁ¨îËÆ∞ (Á¨¨<span id="current-note-page"></span>È°µ)</h3>
            <button onclick="closeNotesModal()">√ó</button>
        </div>
        <textarea id="notes-content" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÊÄùËÄÉÊàñÊÑüÊÉ≥..."></textarea>
        <button onclick="saveNote()" style="width: 100%; padding: 10px; margin-bottom: 10px;">‰øùÂ≠òÁ¨îËÆ∞</button>
        
        <div class="notes-history" id="notes-history"></div>
    </div>

    <!-- Ë∑≥ËΩ¨È°µÈù¢Ê®°ÊÄÅÊ°Ü -->
    <div class="jump-modal" id="jump-modal" style="display: none;">
        <div class="notes-header">
            <h3>Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢</h3>
            <button onclick="closeJumpModal()">√ó</button>
        </div>
        <input type="number" id="jump-page-input" min="1" placeholder="ËæìÂÖ•È°µÁ†Å">
        <button onclick="jumpToPage()" style="width: 100%; padding: 10px;">Ë∑≥ËΩ¨</button>
        <p style="text-align: center; margin-top: 10px; color: #666;">
            ÂÖ± <span id="total-pages-display">0</span> È°µ
        </p>
    </div>

    <!-- ÈÅÆÁΩ©Â±Ç -->
    <div id="sidebar-mask" class="sidebar-mask"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // ÈÖçÁΩÆ‰ø°ÊÅØ
        const config = {
            basePath: './books/',
            supportedFormats: ['jpg', 'png', 'jpeg'],
            books: {
                "Â∞èÂ≠¶ËØ≠Êñá": {
                    type: 'folder',
                    children: {
                        "Â∞èÂ≠¶ÁîüÂøÖËÉåÂè§ËØó": {
                            type: 'book',
                            pages: 194,
                            path: 'chinese-poetry/{page}',
                            audioPath: 'audios/poetry/{page}.mp3'
                        },
                        "‰ΩúÊñáËåÉÊñá": {
                            type: 'book',
                            pages: 36,
                            path: 'chinese-essay/{page}'
                        }
                    }
                }
            },
            // FirebaseÈÖçÁΩÆÔºàÊõøÊç¢‰∏∫ÊÇ®ÁöÑÂÆûÈôÖÈÖçÁΩÆÔºâ
            firebase: {
                apiKey: "AIzaSyABC123XYZ456DEF789GHI",
                authDomain: "your-project-id.firebaseapp.com",
                databaseURL: "https://your-project-id.firebaseio.com",
                projectId: "your-project-id",
                storageBucket: "your-project-id.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abc123def456ghi789jkl"
            }
        };

        // ÂàùÂßãÂåñFirebase
        firebase.initializeApp(config.firebase);
        const database = firebase.database();

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let currentBook = null;
        let currentPage = 1;
        let currentTotalPages = 0;
        let currentFilePattern = { padLength: 1, format: 'jpg' };
        let scale = 1;
        let annotations = [];
        let notes = JSON.parse(localStorage.getItem('localNotes')) || {};
        let isSelectingText = false;
        let selectionStart = null;
        let currentNoteKey = null;
        let audioElement = null;
        let currentAudioPage = 0;

        // ÂàùÂßãÂåñ
        async function init() {
            renderDirectory();
            initEvents();
            loadLastPosition();
            checkOrientation();
            setupFirebaseListeners();
            
            if (localStorage.getItem('nightMode') === 'true') {
                document.body.classList.add('night-mode');
            }
        }

        // ËÆæÁΩÆFirebaseÁõëÂê¨
        function setupFirebaseListeners() {
            database.ref('notes').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                
                // Êõ¥Êñ∞Êú¨Âú∞Á¨îËÆ∞Êï∞ÊçÆ
                Object.entries(data).forEach(([key, note]) => {
                    if (!notes[note.book]) notes[note.book] = {};
                    if (!notes[note.book][note.page]) notes[note.book][note.page] = [];
                    
                    const existingIndex = notes[note.book][note.page].findIndex(n => n.key === key);
                    if (existingIndex >= 0) {
                        notes[note.book][note.page][existingIndex] = { ...note, key };
                    } else {
                        notes[note.book][note.page].push({ ...note, key });
                    }
                });
                
                localStorage.setItem('localNotes', JSON.stringify(notes));
                
                // Â¶ÇÊûúÂΩìÂâçÊâìÂºÄ‰∫ÜÁ¨îËÆ∞Ê®°ÊÄÅÊ°ÜÔºåÂà∑Êñ∞ÊòæÁ§∫
                if (document.getElementById('notes-modal').style.display === 'block') {
                    showNotesModal();
                }
                
                // Êõ¥Êñ∞ÁõÆÂΩï‰∏≠ÁöÑÁ¨îËÆ∞Ê†áËÆ∞
                renderDirectory();
            });
        }

        // Ê∏≤ÊüìÁõÆÂΩï
        function renderDirectory() {
            const container = document.getElementById('directory');
            container.innerHTML = buildTree(config.books);
        }

        // ÁîüÊàêÁõÆÂΩïHTML
        function buildTree(data) {
            return Object.entries(data).map(([name, info]) => {
                if (info.type === 'folder') {
                    return `
                        <div class="folder">
                            <div class="folder-title">${name}</div>
                            <div class="folder-content">
                                ${buildTree(info.children)}
                            </div>
                        </div>
                    `;
                }
                const hasNotes = notes[info.path] && Object.values(notes[info.path]).some(p => p.length > 0);
                return `
                    <div class="book-item" 
                         data-path="${info.path}"
                         data-pages="${info.pages}">
                        ${name} (ÂÖ±${info.pages}È°µ)
                        ${hasNotes ? 'üìù' : ''}
                    </div>
                `;
            }).join('');
        }

        // Âä†ËΩΩ‰π¶Á±ç
        async function loadBook(pathPattern, totalPages) {
            try {
                showLoader(true);
                clearAnnotations();
                stopAudio();
                
                currentBook = pathPattern;
                currentPage = 1;
                currentTotalPages = totalPages;
                
                // Ê£ÄÊµãÊñá‰ª∂ÂëΩÂêçËßÑÂàô
                currentFilePattern = await detectFilePattern(pathPattern);
                
                // Á´ãÂç≥Âä†ËΩΩÂπ∂ÊòæÁ§∫Á¨¨‰∏ÄÈ°µ
                await loadAndRenderPage(currentPage);
                
                // ÂºÇÊ≠•È¢ÑÂä†ËΩΩÂÖ∂‰ªñÈ°µ
                setTimeout(() => preloadAdjacentPages(), 100);
                
                updatePageIndicator();
                savePosition();
                checkNotes();
            } catch (err) {
                console.error('‰π¶Á±çÂä†ËΩΩÂ§±Ë¥•:', err);
                showError(`Êó†Ê≥ïÂä†ËΩΩ‰π¶Á±çÔºö${err.message}`);
            } finally {
                showLoader(false);
            }
        }

        // Ê£ÄÊµãÊñá‰ª∂ÂëΩÂêçËßÑÂàô
        async function detectFilePattern(pathPattern) {
            const testPage = 1;
            
            // ÊµãËØïÊâÄÊúâÂèØËÉΩÁöÑÁªÑÂêà
            for (const padLength of [1, 2, 3]) {
                for (const format of config.supportedFormats) {
                    const url = buildImageUrl(pathPattern, testPage, padLength, format);
                    try {
                        const exists = await checkFileExists(url);
                        if (exists) {
                            console.log('Ê£ÄÊµãÂà∞Êñá‰ª∂Ê†ºÂºè:', {padLength, format});
                            return {padLength, format};
                        }
                    } catch (e) {
                        console.debug(`ÊµãËØïÊñá‰ª∂‰∏çÂ≠òÂú®: ${url}`);
                    }
                }
            }
            
            throw new Error('Êú™ÊâæÂà∞ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂');
        }

        // ÊûÑÂª∫ÂõæÁâáURL
        function buildImageUrl(pattern, page, padLength, format) {
            const padded = page.toString().padStart(padLength, '0');
            return `${config.basePath}${pattern.replace('{page}', padded)}.${format}`;
        }

        // Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
        function checkFileExists(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Âä†ËΩΩÂπ∂Ê∏≤ÊüìÂçïÈ°µ
        async function loadAndRenderPage(page) {
            try {
                const url = getPageUrl(page);
                const img = await loadImage(url);
                renderPage(img, page);
                checkAndLoadAudio(currentBook, page);
            } catch (err) {
                console.error(`Á¨¨${page}È°µÂä†ËΩΩÂ§±Ë¥•:`, err);
                showError(`Á¨¨${page}È°µÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂõæÁâáÊñá‰ª∂`);
                throw err;
            }
        }

        // Âä†ËΩΩÂõæÁâá
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    resolve(img);
                    setTimeout(adjustImageSize, 100); // Âª∂ËøüÁ°Æ‰øùÂõæÁâáÂ∑≤Ê∏≤Êüì
                };
                img.onerror = () => reject(new Error(`Âä†ËΩΩÂ§±Ë¥•: ${url}`));
                img.src = url;
            });
        }

        // Ê∏≤ÊüìÂΩìÂâçÈ°µ
        function renderPage(img, page) {
            const container = document.getElementById('image-viewer');
            container.innerHTML = '';
            
            if (!img) {
                container.innerHTML = `
                    <div class="error-message">
                        <p>ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</p>
                        <button onclick="retryCurrentPage()">ÈáçËØï</button>
                    </div>
                `;
                return;
            }
            
            const imgClone = img.cloneNode();
            imgClone.className = 'page-image';
            container.appendChild(imgClone);
            
            // ÊÅ¢Â§çÊâπÊ≥®
            restoreAnnotations(page);
            
            // Ë∞ÉÊï¥ÂõæÁâáÂ§ßÂ∞è
            adjustImageSize();
        }

        // Ë∞ÉÊï¥ÂõæÁâáÂ§ßÂ∞è
        function adjustImageSize() {
            const container = document.getElementById('image-container');
            const img = document.querySelector('.page-image');
            if (!img) return;

            // ËÆ°ÁÆóÂèØÁî®Á©∫Èó¥
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // ËÆ°ÁÆóÊúÄ‰Ω≥Áº©ÊîæÊØî‰æã
            const widthRatio = containerWidth / img.naturalWidth;
            const heightRatio = containerHeight / img.naturalHeight;
            const minRatio = Math.min(widthRatio, heightRatio);
            
            // Â∫îÁî®Ëá™Âä®Áº©Êîæ
            scale = Math.min(minRatio, 1); // ÂàùÂßã‰∏çÊîæÂ§ßË∂ÖËøá100%
            applyZoom();
        }

        // È¢ÑÂä†ËΩΩÂâçÂêéÈ°µ
        function preloadAdjacentPages() {
            if (!currentBook) return;
            
            const start = Math.max(1, currentPage - 3);
            const end = Math.min(currentTotalPages, currentPage + 3);
            
            for (let i = start; i <= end; i++) {
                if (i !== currentPage) {
                    const url = getPageUrl(i);
                    new Image().src = url; // ÈùôÈªòÈ¢ÑÂä†ËΩΩ
                }
            }
        }

        // Ëé∑ÂèñÂΩìÂâçÈ°µURL
        function getPageUrl(page) {
            return buildImageUrl(
                currentBook,
                page,
                currentFilePattern.padLength,
                currentFilePattern.format
            );
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            const container = document.getElementById('image-viewer');
            container.innerHTML = `
                <div class="error-message">
                    <p>${message}</p>
                    <button onclick="retryCurrentBook()">ÈáçÊñ∞Âä†ËΩΩ</button>
                </div>
            `;
        }

        // Êõ¥Êñ∞È°µÁ†ÅÊòæÁ§∫
        function updatePageIndicator() {
            document.getElementById('page-indicator').textContent = 
                `${currentPage}/${currentTotalPages}`;
        }

        // ‰øùÂ≠òÈòÖËØª‰ΩçÁΩÆ
        function savePosition() {
            if (currentBook) {
                localStorage.setItem('lastPosition', JSON.stringify({
                    bookPath: currentBook,
                    page: currentPage,
                    totalPages: currentTotalPages,
                    pattern: currentFilePattern
                }));
            }
        }

        // Âä†ËΩΩÊúÄÂêéÈòÖËØª‰ΩçÁΩÆ
        function loadLastPosition() {
            const saved = localStorage.getItem('lastPosition');
            if (saved) {
                const { bookPath, page, totalPages, pattern } = JSON.parse(saved);
                currentFilePattern = pattern;
                loadBook(bookPath, totalPages).then(() => {
                    currentPage = Math.min(page, totalPages);
                    loadAndRenderPage(currentPage);
                });
            }
        }

        // Ê£ÄÊü•ÂΩìÂâçÈ°µÁ¨îËÆ∞
        function checkNotes() {
            const notesBtn = document.getElementById('notes-btn');
            if (notes[currentBook] && notes[currentBook][currentPage] && notes[currentBook][currentPage].length > 0) {
                notesBtn.classList.add('notes-active');
            } else {
                notesBtn.classList.remove('notes-active');
            }
        }

        // Èü≥È¢ëÊéßÂà∂ÈÄªËæë
        function checkAndLoadAudio(bookPath, page) {
            const audioControls = document.getElementById('audio-controls');
            const bookConfig = findBookConfig(bookPath);
            
            if (bookConfig && bookConfig.audioPath) {
                const audioUrl = `${config.basePath}${bookConfig.audioPath.replace('{page}', page)}`;
                initAudioPlayer(audioUrl, page);
                audioControls.style.display = 'flex';
            } else {
                audioControls.style.display = 'none';
                stopAudio();
            }
        }

        function findBookConfig(path) {
            // ÈÄíÂΩíÊü•ÊâæÂåπÈÖçÁöÑ‰π¶Á±çÈÖçÁΩÆ
            function search(books) {
                for (const key in books) {
                    const item = books[key];
                    if (item.path === path) return item;
                    if (item.children) {
                        const result = search(item.children);
                        if (result) return result;
                    }
                }
                return null;
            }
            return search(config.books);
        }

        function initAudioPlayer(url, page) {
            // Ê∏ÖÁêÜ‰πãÂâçÁöÑÈü≥È¢ë
            stopAudio();
            currentAudioPage = page;

            audioElement = new Audio(url);
            
            // ‰∫ã‰ª∂ÁõëÂê¨
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('loadedmetadata', () => {
                document.getElementById('audio-time').textContent = 
                    `0:00 / ${formatTime(audioElement.duration)}`;
            });
            audioElement.addEventListener('ended', () => {
                document.getElementById('play-btn').textContent = '‚ñ∂';
            });

            // ËøõÂ∫¶Êù°‰∫§‰∫í
            const progress = document.getElementById('audio-progress');
            progress.addEventListener('click', (e) => {
                const rect = progress.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioElement.currentTime = percent * audioElement.duration;
            });
        }

        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement = null;
                document.getElementById('play-btn').textContent = '‚ñ∂';
            }
        }

        // ËæÖÂä©ÂáΩÊï∞
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            const progressBar = document.getElementById('audio-progress-bar');
            const percent = (audioElement.currentTime / audioElement.duration) * 100;
            progressBar.style.width = `${percent}%`;
            
            document.getElementById('audio-time').textContent = 
                `${formatTime(audioElement.currentTime)} / ${formatTime(audioElement.duration)}`;
        }

        // ÊòæÁ§∫Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü
        function showNotesModal() {
            if (!currentBook) return;
            
            const modal = document.getElementById('notes-modal');
            const pageNotes = notes[currentBook] && notes[currentBook][currentPage] ? 
                notes[currentBook][currentPage] : [];
            
            // ÊòæÁ§∫ÂΩìÂâçÈ°µÁ¨îËÆ∞
            document.getElementById('current-note-page').textContent = currentPage;
            
            // Â¶ÇÊûúÊúâÁ¨îËÆ∞ÔºåÊòæÁ§∫ÊúÄÊñ∞ÁöÑ‰∏ÄÊù°
            if (pageNotes.length > 0) {
                const latestNote = pageNotes.reduce((prev, current) => 
                    (prev.timestamp > current.timestamp) ? prev : current);
                document.getElementById('notes-content').value = latestNote.content;
                currentNoteKey = latestNote.key;
            } else {
                document.getElementById('notes-content').value = '';
                currentNoteKey = null;
            }
            
            // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩï
            const historyContainer = document.getElementById('notes-history');
            if (pageNotes.length > 0) {
                historyContainer.innerHTML = pageNotes
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .map(note => `
                        <div class="note-item">
                            <div class="note-content">${note.content}</div>
                            <div class="note-meta">
                                <span>${new Date(note.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="note-actions">
                                <button onclick="editNote('${note.key}')">ÁºñËæë</button>
                                <button onclick="deleteNote('${note.key}')">Âà†Èô§</button>
                            </div>
                        </div>
                    `).join('');
            } else {
                historyContainer.innerHTML = '<p>ÊöÇÊó†ÂéÜÂè≤Á¨îËÆ∞</p>';
            }
            
            modal.style.display = 'block';
        }

        // ‰øùÂ≠òÁ¨îËÆ∞
        async function saveNote() {
            const content = document.getElementById('notes-content').value.trim();
            if (!content) {
                alert('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ');
                return;
            }

            try {
                const noteData = {
                    content,
                    timestamp: Date.now(),
                    book: currentBook,
                    page: currentPage
                };

                // Â¶ÇÊûúÊúâÊ≠£Âú®ÁºñËæëÁöÑÁ¨îËÆ∞ÔºåÊõ¥Êñ∞ÂÆÉÔºõÂê¶ÂàôÂàõÂª∫Êñ∞Á¨îËÆ∞
                if (currentNoteKey) {
                    await database.ref(`notes/${currentNoteKey}`).update(noteData);
                } else {
                    const newNoteRef = database.ref('notes').push();
                    await newNoteRef.set(noteData);
                    currentNoteKey = newNoteRef.key;
                }

                // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
                if (!notes[currentBook]) notes[currentBook] = {};
                if (!notes[currentBook][currentPage]) notes[currentBook][currentPage] = [];
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËØ•Á¨îËÆ∞
                const existingIndex = notes[currentBook][currentPage].findIndex(n => n.key === currentNoteKey);
                if (existingIndex >= 0) {
                    notes[currentBook][currentPage][existingIndex] = { ...noteData, key: currentNoteKey };
                } else {
                    notes[currentBook][currentPage].push({ ...noteData, key: currentNoteKey });
                }
                
                localStorage.setItem('localNotes', JSON.stringify(notes));
                
                // Êõ¥Êñ∞UI
                checkNotes();
                showNotesModal();
            } catch (error) {
                console.error('‰øùÂ≠òÁ¨îËÆ∞Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÁ¨îËÆ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }

        // ÁºñËæëÁ¨îËÆ∞
        function editNote(noteKey) {
            const note = notes[currentBook][currentPage].find(n => n.key === noteKey);
            if (note) {
                document.getElementById('notes-content').value = note.content;
                currentNoteKey = noteKey;
                document.getElementById('notes-content').focus();
            }
        }

        // Âà†Èô§Á¨îËÆ∞
        async function deleteNote(noteKey) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Á¨îËÆ∞ÂêóÔºü')) {
                try {
                    // Âà†Èô§‰∫ëÁ´ØÊï∞ÊçÆ
                    await database.ref(`notes/${noteKey}`).remove();
                    
                    // Âà†Èô§Êú¨Âú∞Êï∞ÊçÆ
                    notes[currentBook][currentPage] = notes[currentBook][currentPage].filter(n => n.key !== noteKey);
                    localStorage.setItem('localNotes', JSON.stringify(notes));
                    
                    // Êõ¥Êñ∞UI
                    if (notes[currentBook][currentPage].length === 0) {
                        document.getElementById('notes-btn').classList.remove('notes-active');
                    }
                    
                    showNotesModal();
                } catch (error) {
                    console.error('Âà†Èô§Á¨îËÆ∞Â§±Ë¥•:', error);
                    alert('Âà†Èô§Á¨îËÆ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                }
            }
        }

        // ÂÖ≥Èó≠Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü
        function closeNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        // ÊòæÁ§∫Ë∑≥ËΩ¨È°µÈù¢Ê®°ÊÄÅÊ°Ü
        function showJumpModal() {
            if (!currentBook) return;
            
            const modal = document.getElementById('jump-modal');
            document.getElementById('jump-page-input').value = currentPage;
            document.getElementById('jump-page-input').max = currentTotalPages;
            document.getElementById('total-pages-display').textContent = currentTotalPages;
            modal.style.display = 'block';
            document.getElementById('jump-page-input').focus();
        }

        // ÂÖ≥Èó≠Ë∑≥ËΩ¨È°µÈù¢Ê®°ÊÄÅÊ°Ü
        function closeJumpModal() {
            document.getElementById('jump-modal').style.display = 'none';
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢
        function jumpToPage() {
            const input = document.getElementById('jump-page-input');
            let page = parseInt(input.value);
            
            if (isNaN(page) || page < 1 || page > currentTotalPages) {
                alert(`ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ°µÁ†Å (1-${currentTotalPages})`);
                return;
            }
            
            currentPage = page;
            loadAndRenderPage(currentPage);
            updatePageIndicator();
            savePosition();
            checkNotes();
            closeJumpModal();
        }

        // ÊâπÊ≥®ÂäüËÉΩ
        function initTextSelection() {
            const container = document.getElementById('image-viewer');
            
            container.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'IMG') {
                    isSelectingText = true;
                    const rect = e.target.getBoundingClientRect();
                    selectionStart = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (isSelectingText && selectionStart) {
                    clearAnnotations();
                    
                    const img = document.querySelector('.page-image');
                    const rect = img.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    
                    // ÂàõÂª∫‰∏¥Êó∂ÊâπÊ≥®
                    const annotation = document.createElement('div');
                    annotation.className = 'annotation';
                    annotation.style.left = `${Math.min(selectionStart.x, endX)}px`;
                    annotation.style.top = `${Math.min(selectionStart.y, endY)}px`;
                    annotation.style.width = `${Math.abs(endX - selectionStart.x)}px`;
                    annotation.style.height = `${Math.abs(endY - selectionStart.y)}px`;
                    
                    container.appendChild(annotation);
                }
            });
            
            container.addEventListener('mouseup', (e) => {
                if (isSelectingText && selectionStart) {
                    const img = document.querySelector('.page-image');
                    const rect = img.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    
                    if (Math.abs(endX - selectionStart.x) > 10 && 
                        Math.abs(endY - selectionStart.y) > 10) {
                        // ‰øùÂ≠òÊâπÊ≥®
                        saveAnnotation(
                            currentPage,
                            selectionStart.x,
                            selectionStart.y,
                            endX - selectionStart.x,
                            endY - selectionStart.y
                        );
                    }
                    
                    isSelectingText = false;
                    selectionStart = null;
                }
            });
        }

        // ‰øùÂ≠òÊâπÊ≥®
        function saveAnnotation(page, x, y, width, height) {
            if (!annotations[currentBook]) {
                annotations[currentBook] = {};
            }
            
            if (!annotations[currentBook][page]) {
                annotations[currentBook][page] = [];
            }
            
            annotations[currentBook][page].push({ x, y, width, height });
            localStorage.setItem('annotations', JSON.stringify(annotations));
            restoreAnnotations(page);
        }

        // ÊÅ¢Â§çÊâπÊ≥®
        function restoreAnnotations(page) {
            if (!annotations[currentBook] || !annotations[currentBook][page]) return;
            
            const container = document.getElementById('image-viewer');
            annotations[currentBook][page].forEach(ann => {
                const annotation = document.createElement('div');
                annotation.className = 'annotation';
                annotation.style.left = `${ann.x}px`;
                annotation.style.top = `${ann.y}px`;
                annotation.style.width = `${ann.width}px`;
                annotation.style.height = `${ann.height}px`;
                container.appendChild(annotation);
            });
        }

        // Ê∏ÖÈô§ÊâπÊ≥®
        function clearAnnotations() {
            document.querySelectorAll('.annotation').forEach(el => el.remove());
        }

        // Áº©ÊîæÂäüËÉΩ
        function applyZoom() {
            const img = document.querySelector('.page-image');
            if (img) {
                img.style.width = `${img.naturalWidth * scale}px`;
                img.style.height = `${img.naturalHeight * scale}px`;
                centerImage();
            }
        }

        // ‰øùÊåÅÂõæÁâáÂ±Ö‰∏≠
        function centerImage() {
            const container = document.getElementById('image-viewer');
            const img = document.querySelector('.page-image');
            if (img) {
                const offsetX = (container.offsetWidth - img.offsetWidth) / 2;
                const offsetY = (container.offsetHeight - img.offsetHeight) / 2;
                container.scrollTo(offsetX, offsetY);
            }
        }

        // Ê®™Â±èÊ£ÄÊµã
        function checkOrientation() {
            function handleOrientationChange() {
                if (window.matchMedia("(orientation: portrait)").matches) {
                    document.querySelector('.orientation-alert').style.display = 'none';
                } else {
                    document.querySelector('.orientation-alert').style.display = 'flex';
                }
            }
            
            window.addEventListener('resize', handleOrientationChange);
            handleOrientationChange();
        }

        // ‰∫ã‰ª∂Â§ÑÁêÜ
        function initEvents() {
            // ËèúÂçïÊåâÈíÆ
            document.getElementById('menu-btn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const mask = document.getElementById('sidebar-mask');
                
                if (sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mask.style.display = 'none';
                } else {
                    sidebar.classList.add('active');
                    mask.style.display = 'block';
                }
            });

            // ÈÅÆÁΩ©Â±ÇÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('sidebar-mask').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-mask').style.display = 'none';
            });

            // Èò≤Ê≠¢ÁÇπÂáª‰æßËæπÊ†èÂÜÖÈÉ®Ëß¶ÂèëÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
            document.getElementById('sidebar').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // ESCÈîÆÂÖ≥Èó≠‰æßËæπÊ†è
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebar-mask').style.display = 'none';
                }
            });

            // ÁõÆÂΩïÈ°πÁÇπÂáª
            document.getElementById('directory').addEventListener('click', (e) => {
                const item = e.target.closest('.book-item');
                if (item) {
                    const path = item.dataset.path;
                    const pages = parseInt(item.dataset.pages);
                    loadBook(path, pages);
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebar-mask').style.display = 'none';
                }
            });

            // ÁøªÈ°µÊéßÂà∂
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAndRenderPage(currentPage);
                    preloadAdjacentPages();
                    updatePageIndicator();
                    savePosition();
                    checkNotes();
                    stopAudio();
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < currentTotalPages) {
                    currentPage++;
                    loadAndRenderPage(currentPage);
                    preloadAdjacentPages();
                    updatePageIndicator();
                    savePosition();
                    checkNotes();
                    stopAudio();
                }
            });

            // Ëß¶Â±èÊªëÂä®
            let touchStartX = 0;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                }
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (e.changedTouches.length !== 1) return;
                
                const diff = touchStartX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentPage < currentTotalPages) {
                        currentPage++;
                        loadAndRenderPage(currentPage);
                        updatePageIndicator();
                        savePosition();
                        checkNotes();
                        stopAudio();
                    } else if (diff < 0 && currentPage > 1) {
                        currentPage--;
                        loadAndRenderPage(currentPage);
                        updatePageIndicator();
                        savePosition();
                        checkNotes();
                        stopAudio();
                    }
                }
            }, { passive: true });

            // ÂèåÊåáÁº©Êîæ
            let initialDistance = null;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && initialDistance) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const newScale = scale * (currentDistance / initialDistance);
                    scale = Math.min(Math.max(newScale, 0.5), 3);
                    applyZoom();
                }
            }, { passive: false });

            document.addEventListener('touchend', () => {
                initialDistance = null;
            });

            // Á¨îËÆ∞ÊåâÈíÆ
            document.getElementById('notes-btn').addEventListener('click', showNotesModal);

            // Áº©ÊîæÊéßÂà∂
            document.getElementById('zoom-btn').addEventListener('click', () => {
                document.getElementById('zoom-menu').classList.toggle('active');
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                scale = Math.min(scale + 0.1, 3);
                applyZoom();
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                scale = Math.max(scale - 0.1, 0.5);
                applyZoom();
            });

            document.getElementById('zoom-reset').addEventListener('click', () => {
                adjustImageSize();
                document.getElementById('zoom-menu').classList.remove('active');
            });

            // Ë∑≥ËΩ¨È°µÈù¢ÊåâÈíÆ
            document.getElementById('jump-btn').addEventListener('click', showJumpModal);

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Áº©ÊîæËèúÂçï
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#zoom-btn') && !e.target.closest('#zoom-menu')) {
                    document.getElementById('zoom-menu').classList.remove('active');
                }
            });

            // Â§úÈó¥Ê®°Âºè
            document.getElementById('night-mode').addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                localStorage.setItem('nightMode', 
                    document.body.classList.contains('night-mode'));
            });

            // Ë∑≥ËΩ¨È°µÈù¢ËæìÂÖ•Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
            document.getElementById('jump-page-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    jumpToPage();
                }
            });

            // Êí≠ÊîæÊåâÈíÆÊéßÂà∂
            document.getElementById('play-btn').addEventListener('click', function() {
                if (!audioElement) return;

                if (audioElement.paused) {
                    audioElement.play();
                    this.textContent = '‚è∏';
                } else {
                    audioElement.pause();
                    this.textContent = '‚ñ∂';
                }
            });

            // Á™óÂè£Â§ßÂ∞èÂèòÂåñÊó∂ÈáçÊñ∞Ë∞ÉÊï¥ÂõæÁâá
            window.addEventListener('resize', () => {
                adjustImageSize();
                centerImage();
            });

            // ÂàùÂßãÂåñÊñáÊú¨ÈÄâÊã©ÊâπÊ≥®
            initTextSelection();
        }

        // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // ÈáçËØïÂΩìÂâçÈ°µ
        function retryCurrentPage() {
            loadAndRenderPage(currentPage);
        }

        // ÈáçËØïÂΩìÂâç‰π¶Á±ç
        function retryCurrentBook() {
            if (currentBook) {
                loadBook(currentBook, currentTotalPages);
            }
        }

        // ÂÖ®Â±ÄÂáΩÊï∞
        window.retryCurrentPage = retryCurrentPage;
        window.retryCurrentBook = retryCurrentBook;
        window.loadBook = loadBook;
        window.showNotesModal = showNotesModal;
        window.closeNotesModal = closeNotesModal;
        window.saveNote = saveNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
        window.showJumpModal = showJumpModal;
        window.closeJumpModal = closeJumpModal;
        window.jumpToPage = jumpToPage;

        // ÂêØÂä®Â∫îÁî®
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>