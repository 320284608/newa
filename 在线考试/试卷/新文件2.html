<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ ä½³æ›¦çƒ¤åœ°ç“œğŸ è€ƒè¯•ç³»ç»ŸğŸ“</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --error: #e74c3c;
            --background: #f8f9fa;
            --text-color: #333;
            --card-background: white;
            --border-color: #eee;
            --progress: 1;
        }

        body.eye-protection-mode {
            --background: #f5f5dc;
            --text-color: #333;
            --card-background: #fffff0;
            --border-color: #ccc;
        }

        body.dark-mode {
            --background: #121212;
            --text-color: #d0d0d0;
            --card-background: #1e1e1e;
            --border-color: #333;
            --primary: #1f1f1f;
            --secondary: #4db8ff;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            margin: 20px;
            background: var(--background);
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            color: var(--text-color);
        }

        .question-card {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin: 15px 0;
            background: var(--card-background);
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(
                var(--secondary) calc(360deg * var(--progress)),
                var(--background) 0
            );
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: pulse 1s infinite alternate;
        }

        .timer::before {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            background: var(--card-background);
            border-radius: 50%;
        }

        .timer span {
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: var(--secondary);
        }

        .time-warning {
            animation: blink 1s infinite;
            background: conic-gradient(
                var(--error) calc(360deg * var(--progress)),
                var(--background) 0
            );
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        @keyframes blink {
            50% { opacity: 0.8; }
        }

        button {
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        #importMenu, #visualEditor, #wxPusherConfig, #giteeConfig {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .import-option, .editor-section {
            margin-bottom: 10px;
        }

        textarea, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            color: var(--text-color);
            margin-bottom: 10px;
        }

        textarea {
            height: 200px;
        }

        .json-example {
            font-family: monospace;
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-item input[type="text"] {
            flex: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }

        .option-item button {
            padding: 6px 12px;
        }

        .correct-answer {
            margin-top: 10px;
        }

        .preview-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed var(--border-color);
            border-radius: 6px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 8px 16px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-bottom: none;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            margin-right: 5px;
        }

        .tab-button.active {
            background: var(--secondary);
            color: white;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropbtn {
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .dropbtn:hover {
            transform: translateY(-2px);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: var(--card-background);
            min-width: 160px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
            border-radius: 6px;
        }

        .dropdown-content a {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-content a:hover {
            background: var(--background);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .config-panel label {
            display: block;
            margin: 10px 0;
        }

        .config-panel input {
            width: calc(100% - 120px);
            margin-left: 10px;
        }

        .gitee-config {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .status-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .success {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--success);
        }

        .error {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--error);
        }

        .url-import {
            margin-top: 15px;
        }
        
        .url-import input {
            width: calc(100% - 100px);
        }
    </style>
</head>

<body class="eye-protection-mode">
    <div class="container">
        <div class="toolbar">
            <select id="themeSelect" onchange="setMode(this.value)">
                <option value="eye-protection">æŠ¤çœ¼æ¨¡å¼</option>
                <option value="dark">å¤œé—´æ¨¡å¼</option>
                <option value="default">é»˜è®¤æ¨¡å¼</option>
            </select>

            <div class="dropdown">
                <button class="dropbtn">åŠŸèƒ½ â–¼</button>
                <div class="dropdown-content">
                    <a href="#" onclick="switchExam()">åˆ‡æ¢è¯•å·</a>
                    <a href="#" onclick="toggleImportMenu()">å¯¼å…¥è¯•å·</a>
                    <a href="#" onclick="showVisualEditor()">å¯è§†åŒ–å‡ºé¢˜</a>
                    <a href="#" onclick="showWxPusherConfig()">æ¨é€é…ç½®</a>
                    <a href="#" onclick="showGiteeConfig()">Giteeé…ç½®</a>
                </div>
            </div>

            <button id="examControlBtn" onclick="startOrSubmitExam()">å¼€å§‹è€ƒè¯•</button>
        </div>

        <h1>ä½³æ›¦ğŸ§¨çƒ¤åœ°ç“œğŸ åœ¨çº¿è€ƒè¯•ç³»ç»ŸğŸ“</h1>
        <label for="studentName">è€ƒç”Ÿå§“å:</label>
        <input type="text" id="studentName" placeholder="è¯·è¾“å…¥è€ƒç”Ÿå§“å" required>
        <div class="timer" id="timer"><span>30:00</span></div>
        
        <div id="wxPusherConfig" class="config-panel">
            <h3>wxPusheræ¶ˆæ¯æ¨é€é…ç½®</h3>
            <label>AppToken:
                <input type="text" id="wxAppToken" placeholder="è¯·è¾“å…¥AppToken">
            </label>
            <label>ç”¨æˆ·UID:
                <input type="text" id="wxUid" placeholder="è¯·è¾“å…¥ç”¨æˆ·UID">
            </label>
            <button onclick="saveWxPusherConfig()">ä¿å­˜é…ç½®</button>
        </div>

        <div id="giteeConfig" class="config-panel">
            <h3>Giteeä»“åº“é…ç½®</h3>
            <div class="gitee-config">
                <label>ä¸ªäººè®¿é—®ä»¤ç‰Œ:
                    <input type="password" id="giteeToken" placeholder="è¯·è¾“å…¥Gitee token">
                </label>
                <label>ä»“åº“åç§°:
                    <input type="text" id="giteeRepo" placeholder="ä¾‹å¦‚ï¼šusername/repo">
                </label>
                <label>æ–‡ä»¶è·¯å¾„:
                    <input type="text" id="giteePath" placeholder="ä¾‹å¦‚ï¼šdata/exam.json">
                </label>
                <button onclick="saveGiteeConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div id="importMenu">
            <div class="tab-buttons">
                <div class="tab-button active" onclick="switchTab('fileTab')">æœ¬åœ°ä¸Šä¼ </div>
                <div class="tab-button" onclick="switchTab('pasteTab')">AIæ•°æ®</div>
                <div class="tab-button" onclick="switchTab('giteeTab')">Giteeä»“åº“</div>
            </div>
            
            <div id="fileTab" class="import-option">
                <h3>æ–¹å¼ä¸€ï¼šä¸Šä¼ JSONæ–‡ä»¶</h3>
                <input type="file" id="importFile" accept=".json">
                <button onclick="importFromFile()">ç¡®è®¤ä¸Šä¼ </button>
            </div>
            
            <div id="pasteTab" class="import-option" style="display:none;">
                <h3>æ–¹å¼äºŒï¼šé—®åˆ«çš„AIè¦æ•°æ®</h3>
                <textarea id="jsonInput" placeholder="è¯·åœ¨æ­¤ç²˜è´´JSONæ ¼å¼çš„è¯•å·æ•°æ®..."></textarea>
                <button onclick="importFromText()">ç¡®è®¤å¯¼å…¥</button>
                <button onclick="uploadToGiteeFromText()" style="margin-left:10px;">ä¸Šä¼ åˆ°Gitee</button>
                
                <details>
                    <summary>å¤åˆ¶ä»¥ä¸‹JSONæ ¼å¼ç¤ºä¾‹</summary>
                    <div class="json-example">
[
    {
        "type": "radio",
        "content": "ä¸­å›½çš„é¦–éƒ½æ˜¯å“ªä¸ªåŸå¸‚ï¼Ÿ",
        "options": ["åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·"],
        "correct": "A"
    },
    {
        "type": "text",
        "content": "ã€Šé™å¤œæ€ã€‹çš„ä½œè€…æ˜¯è°ï¼Ÿ",
        "correct": "æç™½"
    },
    {
        "type": "checkbox",
        "content": "ä»¥ä¸‹å“ªäº›æ˜¯æ°´æœï¼Ÿ",
        "options": ["è‹¹æœ", "åœŸè±†", "é¦™è•‰", "è¥¿çº¢æŸ¿"],
        "correct": ["A", "C"]
    }
]
                    </div>
                </details>
            </div>
            
            <div id="giteeTab" class="import-option" style="display:none;">
                <h3>æ–¹å¼ä¸‰ï¼šä»Giteeä»“åº“å¯¼å…¥</h3>
                
                <div class="url-import">
                    <h4>é€šè¿‡URLå¯¼å…¥ï¼š</h4>
                    <input type="text" id="giteeUrl" placeholder="è¾“å…¥Gitee RAWæ–‡ä»¶URLï¼Œä¾‹å¦‚ï¼šhttps://gitee.com/ç”¨æˆ·å/ä»“åº“/raw/master/è¯•å·.json">
                    <button onclick="importFromGiteeUrl()">å¯¼å…¥URL</button>
                </div>
                
                <div style="margin:15px 0; text-align:center;">æˆ–</div>
                
                <h4>é€šè¿‡APIå¯¼å…¥ï¼ˆéœ€é…ç½®ï¼‰ï¼š</h4>
                <button onclick="importFromGitee()">è·å–æœ€æ–°è¯•å·</button>
                <div id="giteeStatus" class="status-message"></div>
            </div>
        </div>

        <div id="visualEditor">
            <h2>å¯è§†åŒ–é¢˜ç›®ç¼–è¾‘å™¨</h2>
            <div class="editor-section">
                <label for="questionType">é¢˜ç›®ç±»å‹:</label>
                <select id="questionType" onchange="changeQuestionType()">
                    <option value="radio">å•é€‰é¢˜</option>
                    <option value="checkbox">å¤šé€‰é¢˜</option>
                    <option value="text">å¡«ç©ºé¢˜</option>
                </select>
            </div>
            
            <div class="editor-section">
                <label for="questionContent">é¢˜ç›®å†…å®¹:</label>
                <textarea id="questionContent" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹..."></textarea>
            </div>
            
            <div id="optionsSection" class="editor-section">
                <label>é¢˜ç›®é€‰é¡¹:</label>
                <div id="optionsContainer">
                    <div class="option-item">
                        <input type="text" placeholder="é€‰é¡¹A">
                        <button onclick="removeOption(this)">åˆ é™¤</button>
                    </div>
                    <div class="option-item">
                        <input type="text" placeholder="é€‰é¡¹B">
                        <button onclick="removeOption(this)">åˆ é™¤</button>
                    </div>
                </div>
                <button onclick="addOption()">æ·»åŠ é€‰é¡¹</button>
            </div>
            
            <div id="correctAnswerSection" class="editor-section correct-answer">
                <label>æ­£ç¡®ç­”æ¡ˆ:</label>
                <div id="radioAnswer" style="display:block;">
                    <select id="radioCorrect">
                        <option value="A">A</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div id="checkboxAnswer" style="display:none;">
                    <label><input type="checkbox" name="checkboxCorrect" value="A"> A</label>
                    <label><input type="checkbox" name="checkboxCorrect" value="B"> B</label>
                </div>
                <div id="textAnswer" style="display:none;">
                    <input type="text" id="textCorrect" placeholder="è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ">
                </div>
            </div>
            
            <div class="editor-section">
                <button onclick="addQuestion()">æ·»åŠ åˆ°è¯•å·</button>
                <button onclick="generateJson()">ç”ŸæˆJSON</button>
                <button onclick="clearEditor()">æ¸…ç©ºç¼–è¾‘å™¨</button>
            </div>
            
            <div class="preview-area">
                <h3>å½“å‰è¯•å·é¢„è§ˆ (å…±<span id="questionCount">0</span>é¢˜)</h3>
                <div id="questionPreview"></div>
                <button onclick="saveQuestions()" style="margin-top:10px;">ä¿å­˜ä¸ºå½“å‰è¯•å·</button>
                <button onclick="uploadToGitee()" style="margin-left:10px;">ä¸Šä¼ åˆ°Gitee</button>
            </div>
        </div>

        <div id="questionContainer"></div>
    </div>

    <script>
        // ================= å…¨å±€å˜é‡ =================
        let currentQuestions = [];
        let currentExam = 'questions.json';
        let timeLeft = 1800;
        let timerInterval;
        let examStarted = false;
        let editorQuestions = [];

        // ================= ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ =================
        function setMode(mode) {
            document.body.className = mode + '-mode';
            localStorage.setItem('mode', mode);
        }

        // ================= åˆå§‹åŒ– =================
        window.onload = function() {
            const savedMode = localStorage.getItem('mode') || 'eye-protection';
            document.getElementById('themeSelect').value = savedMode;
            setMode(savedMode);
            
            currentQuestions = [];
            renderQuestions();
            
            document.getElementById('importMenu').style.display = 'none';
            document.getElementById('visualEditor').style.display = 'none';
            document.getElementById('wxPusherConfig').style.display = 'none';
            document.getElementById('giteeConfig').style.display = 'none';
            
            document.getElementById('questionContainer').style.pointerEvents = 'none';
            document.getElementById('questionContainer').style.opacity = '0.6';
            
            document.documentElement.style.setProperty('--progress', 1);
        };

        // ================= GiteeåŠŸèƒ½ =================
        function showGiteeConfig() {
            hideAllPanels();
            const config = JSON.parse(localStorage.getItem('giteeConfig') || '{}');
            document.getElementById('giteeToken').value = config.token || '';
            document.getElementById('giteeRepo').value = config.repo || '';
            document.getElementById('giteePath').value = config.path || '';
            document.getElementById('giteeConfig').style.display = 'block';
        }

        function saveGiteeConfig() {
            const config = {
                token: document.getElementById('giteeToken').value.trim(),
                repo: document.getElementById('giteeRepo').value.trim(),
                path: document.getElementById('giteePath').value.trim()
            };

            if (!config.token || !config.repo || !config.path) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
                return;
            }

            localStorage.setItem('giteeConfig', JSON.stringify(config));
            showStatus('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
        }

        async function importFromGitee() {
            const config = JSON.parse(localStorage.getItem('giteeConfig') || '{}');
            if (!config.token) {
                showStatus('è¯·å…ˆé…ç½®Giteeä¿¡æ¯', 'error', 'giteeStatus');
                return;
            }

            showStatus('æ­£åœ¨ä»Giteeè·å–è¯•å·...', '', 'giteeStatus');

            try {
                const response = await fetch(
                    `https://gitee.com/api/v5/repos/${config.repo}/contents/${config.path}?access_token=${config.token}`
                );
                
                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                
                const data = await response.json();
                if (!data.content) throw new Error('æ— æ•ˆçš„æ–‡ä»¶å†…å®¹');
                
                const content = decodeBase64(data.content);
                const jsonData = JSON.parse(content);
                
                validateAndImport(jsonData);
                currentExam = 'gitee';
                showStatus(`æˆåŠŸå¯¼å…¥ ${jsonData.length} é“é¢˜ç›®`, 'success', 'giteeStatus');
            } catch (error) {
                console.error('Giteeå¯¼å…¥é”™è¯¯:', error);
                showStatus(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error', 'giteeStatus');
            }
        }

        async function importFromGiteeUrl() {
            const giteeUrl = document.getElementById('giteeUrl').value.trim();
            
            if (!giteeUrl) {
                showStatus('è¯·è¾“å…¥Giteeæ–‡ä»¶URL', 'error', 'giteeStatus');
                return;
            }
            
            if (!giteeUrl.match(/^https:\/\/gitee\.com\/.+\/.+\/raw\/.+/)) {
                showStatus('URLæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨RAWæ–‡ä»¶URL', 'error', 'giteeStatus');
                return;
            }
            
            showStatus('æ­£åœ¨ä»URLè·å–è¯•å·...', '', 'giteeStatus');
            
            try {
                const response = await fetch(giteeUrl);
                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                
                const jsonData = await response.json();
                validateAndImport(jsonData);
                currentExam = 'gitee-url';
                showStatus(`æˆåŠŸå¯¼å…¥ ${jsonData.length} é“é¢˜ç›®`, 'success', 'giteeStatus');
            } catch (error) {
                console.error('Gitee URLå¯¼å…¥é”™è¯¯:', error);
                showStatus(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error', 'giteeStatus');
            }
        }

        async function uploadToGitee() {
            if (editorQuestions.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ é¢˜ç›®', 'error');
                return;
            }

            const config = JSON.parse(localStorage.getItem('giteeConfig') || '{}');
            if (!config.token) {
                showStatus('è¯·å…ˆé…ç½®Giteeä¿¡æ¯', 'error');
                return;
            }

            showStatus('æ­£åœ¨ä¸Šä¼ åˆ°Gitee...', '');

            try {
                const content = JSON.stringify(editorQuestions, null, 2);
                const base64Content = encodeBase64(content);
                
                let sha = '';
                try {
                    const getResponse = await fetch(
                        `https://gitee.com/api/v5/repos/${config.repo}/contents/${config.path}?access_token=${config.token}`
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {}

                const response = await fetch(
                    `https://gitee.com/api/v5/repos/${config.repo}/contents/${config.path}?access_token=${config.token}`, 
                    {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            content: base64Content,
                            message: 'æ›´æ–°è€ƒè¯•è¯•å·æ•°æ®',
                            sha: sha || undefined
                        })
                    }
                );

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'ä¸Šä¼ å¤±è´¥');
                }

                showStatus('è¯•å·å·²æˆåŠŸä¸Šä¼ åˆ°Gitee', 'success');
            } catch (error) {
                console.error('Giteeä¸Šä¼ é”™è¯¯:', error);
                showStatus(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function uploadToGiteeFromText() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            if (!jsonText) {
                showStatus('è¯·å…ˆè¾“å…¥JSONæ•°æ®', 'error');
                return;
            }

            try {
                const jsonData = JSON.parse(jsonText);
                editorQuestions = jsonData;
                await uploadToGitee();
            } catch (error) {
                showStatus(`JSONè§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function decodeBase64(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch {
                return atob(str);
            }
        }

        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function showStatus(message, type, elementId = 'giteeStatus') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status-message';
            if (type) element.classList.add(type);
        }

        // ================= wxPusheråŠŸèƒ½ =================
        function showWxPusherConfig() {
            hideAllPanels();
            document.getElementById('wxAppToken').value = localStorage.getItem('wxAppToken') || '';
            document.getElementById('wxUid').value = localStorage.getItem('wxUid') || '';
            document.getElementById('wxPusherConfig').style.display = 'block';
        }

        function saveWxPusherConfig() {
            const appToken = document.getElementById('wxAppToken').value.trim();
            const uid = document.getElementById('wxUid').value.trim();
            if (!appToken || !uid) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
                return;
            }
            localStorage.setItem('wxAppToken', appToken);
            localStorage.setItem('wxUid', uid);
            showStatus('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
        }

        async function sendWxPusherMessage(content) {
            const appToken = localStorage.getItem('wxAppToken');
            const uid = localStorage.getItem('wxUid');
            if (!appToken || !uid) return false;

            try {
                const response = await fetch('https://wxpusher.zjiecode.com/api/send/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appToken,
                        content,
                        contentType: 1,
                        uids: [uid],
                        summary: "è€ƒè¯•ç»“æœé€šçŸ¥"
                    })
                });
                const result = await response.json();
                return result.code === 1000;
            } catch (error) {
                console.error('æ¨é€è¯·æ±‚å¤±è´¥:', error);
                return false;
            }
        }

        // ================= è€ƒè¯•åŠŸèƒ½ =================
        async function startExam() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('è¯·è¾“å…¥è€ƒç”Ÿå§“åï¼');
                return;
            }
            
            try {
                let questions = [];
                if (currentExam === 'gitee') {
                    await importFromGitee();
                    questions = currentQuestions;
                } 
                else if (currentExam === 'gitee-url') {
                    await importFromGiteeUrl();
                    questions = currentQuestions;
                }
                else {
                    const response = await fetch(`./data/${currentExam}`);
                    if (!response.ok) throw new Error(`æ— æ³•åŠ è½½è¯•å·ï¼š${currentExam}`);
                    questions = await response.json();
                }
                
                currentQuestions = questions;
                examStarted = true;
                updateExamControlButton();
                renderQuestions();
                
                document.getElementById('questionContainer').style.pointerEvents = 'auto';
                document.getElementById('questionContainer').style.opacity = '1';
                
                startTimer();
            } catch (error) {
                console.error(error);
                alert('åŠ è½½è¯•å·å¤±è´¥: ' + error.message);
                examStarted = false;
                updateExamControlButton();
            }
        }

        function switchExam() {
            if (examStarted) {
                if (!confirm('è€ƒè¯•å·²ç»å¼€å§‹ï¼Œåˆ‡æ¢è¯•å·å°†é‡ç½®å½“å‰è€ƒè¯•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    return;
                }
            }
            currentExam = currentExam === 'questions.json' ? 'questions1.json' : 'questions.json';
            initExam();
        }

        function renderQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = currentQuestions.map((q, index) => `
                <div class="question-card">
                    <h3>é¢˜ç›® ${index + 1} (${getQuestionTypeName(q.type)})</h3>
                    <p>${q.content}</p>
                    ${q.options ? q.options.map((opt, optIndex) => `
                        <label style="display:block; margin:8px 0;">
                            <input type="${q.type}" name="q${index}" value="${String.fromCharCode(65 + optIndex)}">
                            ${String.fromCharCode(65 + optIndex)}. ${opt}
                        </label>
                    `).join('') : ''}
                    ${q.type === 'text' ? `
                        <input type="text" style="width:100%; padding:8px;" 
                               placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" data-question-id="${index}">
                    ` : ''}
                </div>
            `).join('');
        }

        function getQuestionTypeName(type) {
            return {
                'text': 'å¡«ç©º',
                'radio': 'å•é€‰',
                'checkbox': 'å¤šé€‰'
            }[type] || 'æœªçŸ¥';
        }

        function startOrSubmitExam() {
            if (examStarted) {
                submitExam();
            } else {
                startExam();
            }
        }

        function updateExamControlButton() {
            const btn = document.getElementById('examControlBtn');
            if (examStarted) {
                btn.textContent = 'æäº¤è¯•å·';
                btn.style.backgroundColor = 'var(--success)';
            } else {
                btn.textContent = 'å¼€å§‹è€ƒè¯•';
                btn.style.backgroundColor = 'var(--secondary)';
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 1800;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                const progress = timeLeft / 1800;
                document.documentElement.style.setProperty('--progress', progress);
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            const timer = document.getElementById('timer');
            
            timer.innerHTML = `<span>${minutes}:${seconds}</span>`;
            timer.classList.toggle('time-warning', timeLeft <= 300);
        }

        // ================= å¯¼å…¥åŠŸèƒ½ =================
        function toggleImportMenu() {
            hideAllPanels();
            document.getElementById('importMenu').style.display = 'block';
            switchTab('fileTab');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.import-option').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function importFromFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                showStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    validateAndImport(data);
                    showStatus(`æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®`, 'success');
                } catch (e) {
                    showStatus('æ–‡ä»¶è§£æå¤±è´¥: ' + e.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            reader.readAsText(file);
        }

        function importFromText() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            if (!jsonText) {
                showStatus('è¯·è¾“å…¥JSONæ•°æ®', 'error');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                validateAndImport(data);
                showStatus(`æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®`, 'success');
            } catch (e) {
                showStatus('JSONè§£æå¤±è´¥: ' + e.message, 'error');
            }
        }

        function validateAndImport(data) {
            if (!Array.isArray(data)) {
                throw new Error('è¯•å·æ•°æ®å¿…é¡»æ˜¯æ•°ç»„');
            }
            
            const isValid = data.every(q => {
                return q.content && q.correct && 
                      (q.type === 'text' || (q.options && Array.isArray(q.options)));
            });
            
            if (!isValid) {
                throw new Error('è¯•å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥é¢˜ç›®ç»“æ„');
            }
            
            currentQuestions = data;
            renderQuestions();
        }

        function hideAllPanels() {
            document.getElementById('importMenu').style.display = 'none';
            document.getElementById('visualEditor').style.display = 'none';
            document.getElementById('wxPusherConfig').style.display = 'none';
            document.getElementById('giteeConfig').style.display = 'none';
        }

        // ================= å¯è§†åŒ–ç¼–è¾‘å™¨åŠŸèƒ½ =================
        function showVisualEditor() {
            hideAllPanels();
            document.getElementById('visualEditor').style.display = 'block';
            updatePreview();
        }

        function changeQuestionType() {
            const type = document.getElementById('questionType').value;
            document.getElementById('optionsSection').style.display = 
                type === 'text' ? 'none' : 'block';
            document.getElementById('radioAnswer').style.display = 
                type === 'radio' ? 'block' : 'none';
            document.getElementById('checkboxAnswer').style.display = 
                type === 'checkbox' ? 'block' : 'none';
            document.getElementById('textAnswer').style.display = 
                type === 'text' ? 'block' : 'none';
        }

        function addOption() {
            const container = document.getElementById('optionsContainer');
            const optionCount = container.children.length;
            const nextChar = String.fromCharCode(65 + optionCount);
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" placeholder="é€‰é¡¹${nextChar}">
                <button onclick="removeOption(this)">åˆ é™¤</button>
            `;
            container.appendChild(optionDiv);
            updateAnswerOptions();
        }

        function removeOption(button) {
            const container = document.getElementById('optionsContainer');
            if (container.children.length <= 2) {
                showStatus('è‡³å°‘éœ€è¦ä¸¤ä¸ªé€‰é¡¹', 'error');
                return;
            }
            button.parentElement.remove();
            updateAnswerOptions();
        }

        function updateAnswerOptions() {
            const container = document.getElementById('optionsContainer');
            const options = container.children;
            
            const radioSelect = document.getElementById('radioCorrect');
            radioSelect.innerHTML = '';
            for (let i = 0; i < options.length; i++) {
                const char = String.fromCharCode(65 + i);
                radioSelect.innerHTML += `<option value="${char}">${char}</option>`;
            }
            
            const checkboxContainer = document.getElementById('checkboxAnswer');
            checkboxContainer.innerHTML = '';
            for (let i = 0; i < options.length; i++) {
                const char = String.fromCharCode(65 + i);
                checkboxContainer.innerHTML += `
                    <label><input type="checkbox" name="checkboxCorrect" value="${char}"> ${char}</label>
                `;
            }
        }

        function addQuestion() {
            const type = document.getElementById('questionType').value;
            const content = document.getElementById('questionContent').value.trim();
            
            if (!content) {
                showStatus('è¯·è¾“å…¥é¢˜ç›®å†…å®¹', 'error');
                return;
            }
            
            let options = [];
            let correct = [];
            
            if (type !== 'text') {
                const optionInputs = document.querySelectorAll('#optionsContainer input[type="text"]');
                options = Array.from(optionInputs).map(input => input.value.trim());
                
                if (options.some(opt => !opt)) {
                    showStatus('è¯·å¡«å†™æ‰€æœ‰é€‰é¡¹å†…å®¹', 'error');
                    return;
                }
                
                if (type === 'radio') {
                    correct = [document.getElementById('radioCorrect').value];
                } else {
                    correct = Array.from(document.querySelectorAll('#checkboxAnswer input:checked'))
                                 .map(checkbox => checkbox.value);
                    if (correct.length === 0) {
                        showStatus('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ', 'error');
                        return;
                    }
                }
            } else {
                const answer = document.getElementById('textCorrect').value.trim();
                if (!answer) {
                    showStatus('è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ', 'error');
                    return;
                }
                correct = [answer];
            }
            
            const newQuestion = {
                type,
                content,
                correct
            };
            
            if (type !== 'text') {
                newQuestion.options = options;
            }
            
            editorQuestions.push(newQuestion);
            updatePreview();
            clearEditor();
            showStatus('é¢˜ç›®å·²æ·»åŠ ï¼', 'success');
        }

        function updatePreview() {
            const preview = document.getElementById('questionPreview');
            const count = document.getElementById('questionCount');
            
            count.textContent = editorQuestions.length;
            preview.innerHTML = editorQuestions.map((q, index) => `
                <div style="margin-bottom:15px; padding:10px; border-bottom:1px solid var(--border-color);">
                    <strong>é¢˜ç›® ${index + 1}:</strong> ${q.content}
                    <div style="font-size:0.9em; color:#666;">
                        ç±»å‹: ${getQuestionTypeName(q.type)} | 
                        æ­£ç¡®ç­”æ¡ˆ: ${Array.isArray(q.correct) ? q.correct.join(', ') : q.correct}
                    </div>
                </div>
            `).join('');
        }

        function clearEditor() {
            document.getElementById('questionContent').value = '';
            document.getElementById('textCorrect').value = '';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = `
                <div class="option-item">
                    <input type="text" placeholder="é€‰é¡¹A">
                    <button onclick="removeOption(this)">åˆ é™¤</button>
                </div>
                <div class="option-item">
                    <input type="text" placeholder="é€‰é¡¹B">
                    <button onclick="removeOption(this)">åˆ é™¤</button>
                </div>
            `;
            updateAnswerOptions();
        }

        function generateJson() {
            if (editorQuestions.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ é¢˜ç›®', 'error');
                return;
            }
            
            const jsonStr = JSON.stringify(editorQuestions, null, 2);
            document.getElementById('jsonInput').value = jsonStr;
            switchTab('pasteTab');
            document.getElementById('importMenu').style.display = 'block';
            document.getElementById('visualEditor').style.display = 'none';
            showStatus('å·²ç”ŸæˆJSONæ•°æ®', 'success');
        }

        function saveQuestions() {
            if (editorQuestions.length === 0) {
                showStatus('è¯·å…ˆæ·»åŠ é¢˜ç›®', 'error');
                return;
            }
            
            currentQuestions = [...editorQuestions];
            renderQuestions();
            showStatus(`å·²ä¿å­˜ ${editorQuestions.length} é“é¢˜ç›®ä¸ºå½“å‰è¯•å·`, 'success');
            document.getElementById('visualEditor').style.display = 'none';
        }

        // ================= æäº¤åŠŸèƒ½ =================
        async function submitExam() {
            clearInterval(timerInterval);

            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('è¯·è¾“å…¥è€ƒç”Ÿå§“åï¼');
                return;
            }

            const { score, wrongQuestions } = calculateScore();
            const timeUsed = 1800 - timeLeft;
            const minutes = Math.floor(timeUsed / 60).toString().padStart(2, '0');
            const seconds = (timeUsed % 60).toString().padStart(2, '0');
            
            const resultContent = `ğŸ‰è€ƒè¯•ç»“æŸï¼\n\nğŸ‘¤è€ƒç”Ÿå§“å: ${studentName}\nğŸ“Šå¾—åˆ†: ${score}/${currentQuestions.length}\nâ±ï¸ç”¨æ—¶: ${minutes}:${seconds}\nâŒç­”é”™é¢˜ç›®ç¼–å·: ${wrongQuestions.map(q => q.index + 1).join(', ') || 'æ— '}`;
            
            alert(resultContent);
            
            const appToken = localStorage.getItem('wxAppToken');
            const uid = localStorage.getItem('wxUid');
            if (appToken && uid) {
                try {
                    const success = await sendWxPusherMessage(resultContent);
                    if (success) {
                        alert('æˆç»©å·²æ¨é€è‡³å¾®ä¿¡');
                    }
                } catch (error) {
                    console.error('æ¨é€å¤±è´¥:', error);
                }
            }
            
            examStarted = false;
            updateExamControlButton();
            document.getElementById('questionContainer').style.pointerEvents = 'none';
            document.getElementById('questionContainer').style.opacity = '0.6';
        }

        function calculateScore() {
            let score = 0;
            const wrongQuestions = [];

            currentQuestions.forEach((q, index) => {
                const correctAnswers = Array.isArray(q.correct) ? 
                    q.correct.map(a => a.toUpperCase()) : 
                    [q.correct.toUpperCase()];
                const userAnswers = getAnswers(index, q.type);

                if (arraysEqual(correctAnswers, userAnswers)) {
                    score++;
                } else {
                    wrongQuestions.push({
                        index,
                        question: q.content,
                        userAnswer: userAnswers,
                        correctAnswer: correctAnswers
                    });
                }
            });

            return { score, wrongQuestions };
        }

        function getAnswers(index, type) {
            if (type === 'text') {
                const input = document.querySelector(`input[data-question-id="${index}"]`);
                return [input.value.trim().toUpperCase()];
            }
            return Array.from(document.querySelectorAll(`input[name="q${index}"]:checked`))
                .map(el => el.value.toUpperCase());
        }

        // ================= å·¥å…·å‡½æ•° =================
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            const sortedA = [...a].sort();
            const sortedB = [...b].sort();
            return sortedA.every((val, i) => val === sortedB[i]);
        }

        function initExam() {
            clearInterval(timerInterval);
            timeLeft = 1800;
            updateTimerDisplay();
            examStarted = false;
            updateExamControlButton();
            currentQuestions = [];
            renderQuestions();
            document.getElementById('questionContainer').style.pointerEvents = 'none';
            document.getElementById('questionContainer').style.opacity = '0.6';
        }
    </script>
</body>
</html>